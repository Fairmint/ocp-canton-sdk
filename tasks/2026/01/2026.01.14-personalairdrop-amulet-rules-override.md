# Task: Support PersonalAirdrop AmuletRules Override

## Status: Complete

**Created**: 2026-01-14 **Completed**: 2026-01-16 **Priority**: Medium

## Summary

Update the ocp-canton-sdk to support the new `amuletRulesCidOverride` parameter added to
`PersonalAirdrop_ExecuteTransfer` choice in CantonPayments v0.0.31.

## Resolution

The blocking dependency (`@fairmint/open-captable-protocol-daml-js` v0.2.106) now includes the
`amuletRulesCidOverride` parameter in `PersonalAirdrop_ExecuteTransfer`.

**No SDK changes required**: The SDK does not currently have any code that directly exercises
`PersonalAirdrop_ExecuteTransfer`. The SDK's airdrop functions use the `Airdrop_Execute` choice
instead, which operates at a higher level.

- `grep -r "PersonalAirdrop_ExecuteTransfer" src/` returns no matches
- `grep -r "PersonalAirdrop" src/` returns no matches (only unrelated `OcfEmailTypePersonal`)

Phase 2 (adding optional override support to SDK signatures) remains available for future
implementation if direct `PersonalAirdrop_ExecuteTransfer` support is added to the SDK.

## Background

The DAML `PersonalAirdrop_ExecuteTransfer` choice now accepts an optional `amuletRulesCidOverride`
parameter:

- When `None`/`null`: Uses stored `amuletRulesCid` (existing behavior)
- When `Some`/provided: Uses the provided AmuletRules contract ID

This change was made in `open-captable-protocol-daml` to enable updating AmuletRules references
without recreating contracts.

## Implementation Steps

### Phase 1: Backwards Compatible Update

1. Update `@fairmint/open-captable-protocol-daml-js` dependency to latest version with
   CantonPayments v0.0.31

2. Find all SDK functions that exercise `PersonalAirdrop_ExecuteTransfer`:

   ```bash
   grep -r "PersonalAirdrop_ExecuteTransfer" src/
   ```

3. Update each exercise call to pass `null` for `amuletRulesCidOverride`:

   ```typescript
   // Before
   await ledger.exercise(PersonalAirdrop_ExecuteTransfer, {
     amuletInputs,
     openMiningRoundCid,
     amount,
     numberOfTransfers,
     optMergeAmuletInputs,
   });

   // After
   await ledger.exercise(PersonalAirdrop_ExecuteTransfer, {
     amuletInputs,
     openMiningRoundCid,
     amount,
     numberOfTransfers,
     optMergeAmuletInputs,
     amuletRulesCidOverride: null, // NEW: pass null for default behavior
   });
   ```

### Phase 2: Add Override Support (Optional, Future)

1. Add optional `amuletRulesCidOverride` parameter to relevant SDK function signatures

2. Update type definitions if needed

3. Document the new parameter in JSDoc comments

## Testing Requirements

- [x] Update unit tests for any modified SDK functions (N/A - no SDK changes)
- [x] Run integration tests to verify backwards compatibility (N/A - no SDK changes)
- [x] Verify `npm run fix` passes (linting/formatting)
- [x] Verify `npm run typecheck` passes (TypeScript)

## Acceptance Criteria

- [x] SDK compiles with new DAML package version
- [x] All existing tests pass
- [x] Exercise calls include `amuletRulesCidOverride: null` (N/A - no direct usage)
- [x] No runtime behavior changes (backwards compatible)

## Related

- DAML PR: CantonPayments v0.0.31 - PersonalAirdrop AmuletRules Override
- Release Notes: `docs/releases/2026.01.14-cantonpayments-amulet-rules-override.md`
