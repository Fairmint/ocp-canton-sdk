# Task: Add NPM Pinned Dependencies CI Check

## Status: Open

**Created**: 2026-01-14

## Summary

Add a CI check to enforce that all NPM dependencies use pinned (exact) versions without `^` or `~`
prefixes. This ensures consistent builds and prevents unexpected dependency updates.

## Background

The project convention is to always use pinned dependencies:

- ✅ Correct: `"jsonwebtoken": "9.0.3"`
- ❌ Wrong: `"jsonwebtoken": "^9.0.3"` or `"~9.0.3"`

This is documented in `llms.txt` under "Non-Negotiables" but is not automatically enforced. A recent
PR accidentally introduced a caret prefix, which was caught in code review but should be caught
automatically.

## Implementation Options

### Option 1: ESLint Plugin (Recommended)

Use `eslint-plugin-package-json` or similar to lint `package.json`:

```bash
npm install --save-dev eslint-plugin-package-json
```

Configure a rule to disallow `^` and `~` version prefixes.

### Option 2: Custom Script

Create a script that parses `package.json` and checks for version prefixes:

```typescript
// scripts/check-pinned-deps.ts
import pkg from '../package.json';

const checkVersions = (deps: Record<string, string>, section: string) => {
  for (const [name, version] of Object.entries(deps)) {
    if (version.startsWith('^') || version.startsWith('~')) {
      console.error(`${section}: ${name} has unpinned version "${version}"`);
      process.exitCode = 1;
    }
  }
};

checkVersions(pkg.dependencies ?? {}, 'dependencies');
checkVersions(pkg.devDependencies ?? {}, 'devDependencies');
checkVersions(pkg.peerDependencies ?? {}, 'peerDependencies');
```

Add to `package.json`:

```json
"scripts": {
  "check:deps": "ts-node scripts/check-pinned-deps.ts"
}
```

### Option 3: npm-package-json-lint

Use `npm-package-json-lint` with a configuration file:

```bash
npm install --save-dev npm-package-json-lint
```

Create `.npmpackagejsonlintrc.json`:

```json
{
  "rules": {
    "prefer-no-version-zero-dependencies": "error",
    "prefer-caret-version-dependencies": "off",
    "prefer-caret-version-devDependencies": "off"
  }
}
```

Note: May need custom rule for strict pinned versions.

## CI Integration

Add the check to `.github/workflows/ci.yml`:

```yaml
- name: Check pinned dependencies
  run: npm run check:deps
```

## Acceptance Criteria

- [ ] CI fails if any dependency uses `^` or `~` prefix
- [ ] Clear error message indicating which dependency is unpinned
- [ ] Check runs on every PR
- [ ] Documentation updated if new tooling is added

## Related

- llms.txt "Non-Negotiables" section (rule #9)
- PR #151 feedback: dependency accidentally used `^` prefix
