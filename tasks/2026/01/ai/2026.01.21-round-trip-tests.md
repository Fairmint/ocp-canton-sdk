# Round-trip Tests

**Date**: 2026-01-21  
**Status**: Open  
**Priority**: Medium  
**Source**: [OCP Protocol Review](./2026.01.21-ocp-protocol-review.md) — Issues 5.1, 5.2

## Problem

1. The `ocfToDaml.ts` dispatcher has 48 entity cases but limited unit tests
2. No tests verify that `toDaml → toOcf` round-trips produce equivalent data

## Recommendation

Add property-based tests and round-trip tests:

```typescript
// Property-based test
test.prop([fc.record({ id: fc.uuid(), name: fc.object({ legal_name: fc.string() }) })])(
  'stakeholderDataToDaml preserves id',
  (data) => {
    const result = convertToDaml('stakeholder', data as OcfStakeholder);
    expect(result.id).toBe(data.id);
  }
);

// Round-trip test
test('stakeholder round-trips correctly', () => {
  const original: OcfStakeholder = { id: 'sh-1', name: { legal_name: 'Test' }, ... };
  const daml = convertToDaml('stakeholder', original);
  const roundTripped = convertToOcf('stakeholder', daml);
  expect(roundTripped).toEqual(original);
});
```

## Tasks

- [ ] Add `fast-check` or similar property-based testing library
- [ ] Create property generators for each OCF entity type
- [ ] Add property-based tests for each converter
- [ ] Add round-trip tests for each entity type
- [ ] Document any expected differences (e.g., normalized numerics)

## Acceptance Criteria

- Property-based tests for all 48 entity converters
- Round-trip tests verify OCF → DAML → OCF equivalence
- Any intentional differences documented
- Tests run in CI
