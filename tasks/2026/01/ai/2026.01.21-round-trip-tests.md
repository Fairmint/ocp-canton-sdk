# Round-trip Tests

**Date**: 2026-01-21  
**Status**: Complete  
**Priority**: Medium  
**Source**: [OCP Protocol Review](./2026.01.21-ocp-protocol-review.md) — Issues 5.1, 5.2

## Problem

1. The `ocfToDaml.ts` dispatcher has 48 entity cases but limited unit tests
2. No tests verify that `toDaml → toOcf` round-trips produce equivalent data

## Resolution

Analysis on 2026-01-22 shows the core requirements have been implemented:

### What Was Implemented

1. **fast-check installed** ✅ - Already in `package.json` and actively used

2. **Property-based tests** ✅ exist in `test/property/`:
   - `typeConversions.property.test.ts` - numeric normalization, date round-trips, monetary
     round-trips (500+ test runs each)
   - `entityConversions.property.test.ts` - address round-trip tests with unicode, edge cases

3. **Round-trip tests** ✅ exist for complex entity types:
   - `test/converters/acceptanceConverters.test.ts` - 4 types with explicit round-trip tests
   - `test/converters/valuationVestingConverters.test.ts` - valuation and vesting acceleration
     round-trips
   - `test/converters/exerciseConversionConverters.test.ts` - 3 types, both directions
   - `test/converters/stockClassAdjustmentConverters.test.ts` - 4 types, both directions
   - `test/converters/transferConverters.test.ts` - 4 types
   - `test/converters/stockPlanConverters.test.ts` - stock plan conversions

4. **Integration tests** provide end-to-end round-trip coverage

### Why Remaining Work Was Not Done

Adding property tests for all 46+ entity types would provide **minimal additional value**:

- Most entity converters follow identical simple patterns (date formatting, null handling)
- The complex cases (nested structures, numeric conversions) are already covered
- Integration tests validate real DAML contract behavior

## Original Tasks

- [x] Add `fast-check` or similar property-based testing library
- [x] Create property generators for core types (address, monetary, date, numeric)
- [x] Add property-based tests for core converters
- [x] Add round-trip tests for complex entity types
- [x] Document expected differences (normalized numerics handled in tests)
- [~] Property-based tests for all 48 converters - DEFERRED (low ROI)

## Changelog

| Date       | Description                                                | PR  |
| ---------- | ---------------------------------------------------------- | --- |
| 2026-01-22 | Closed as complete - core requirements already implemented | —   |
