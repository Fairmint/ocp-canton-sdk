# Batch Cap Table Updates

**Date**: 2026-01-12  
**Status**: Open  
**Priority**: High  
**ADR**: [ADR-001: Batch Cap Table Updates](../../../../adr/001-batch-cap-table-updates.md)

## Overview

Redesign the SDK to use the DAML CapTable's unified `UpdateCapTable` choice, which supports batch creates, edits, and deletes in a single atomic transaction. This replaces the current per-entity function pattern.

## Problem

The SDK currently uses individual DAML choices (`CreateStakeholder`, `EditStockClass`, etc.) but the DAML contract has evolved to use a batch `UpdateCapTable` choice:

```typescript
interface UpdateCapTable {
  creates: OcfCreateData[];  // Tagged union of 48 entity types
  edits: OcfEditData[];
  deletes: OcfObjectId[];
}
```

This mismatch means:
- 27 entity types are unsupported (SDK: 21, DAML: 48)
- No atomic multi-entity transactions
- Individual choices may be deprecated

## Solution

See [ADR-001](../../../../adr/001-batch-cap-table-updates.md) for the full design proposal.

**Summary**: Implement a fluent batch builder API:

```typescript
const result = await ocp.capTable.update({ capTableContractId })
  .create('stakeholder', stakeholderData)
  .create('stockClass', stockClassData)
  .edit('stockIssuance', updatedIssuanceData)
  .delete('document', 'doc-123')
  .execute();
```

## Implementation Checklist

### Phase 1: Core Batch API

- [ ] Update `@fairmint/open-captable-protocol-daml-js` to v0.2.85
- [ ] Implement `CapTableBatch` class with fluent builder pattern
- [ ] Implement `buildUpdateCapTableCommand()` function
- [ ] Add type definitions for batch operations
- [ ] Add unit tests for batch builder

### Phase 2: Centralized Converters

- [ ] Extract converter functions from existing code
- [ ] Create `src/utils/ocfToDaml.ts` dispatcher
- [ ] Add converters for all 48 entity types
- [ ] Add unit tests for converters

### Phase 3: Integration

- [ ] Add integration tests for batch operations
- [ ] Update `OcpClient` to expose batch API
- [ ] Deprecate individual `create*`/`edit*`/`delete*` functions
- [ ] Update documentation

### Phase 4: Cleanup

- [ ] Move deprecated functions to `legacy/` folder
- [ ] Update all internal usage to batch API
- [ ] Consider removing deprecated functions in next major version

## Validation

```bash
npm run fix                    # Lint/format
npm run typecheck              # Type check
npm test                       # Unit tests
npm run test:integration       # Integration tests
```

## Related

- [ADR-001: Batch Cap Table Updates](../../../../adr/001-batch-cap-table-updates.md)
- [Milestone 2: OCP SDK Implementation](../../2025/12/2025.12.17-milestone-2-ocp-sdk-implementation.md)
- [Remaining Integration Tests](./2026.01.08-remaining-integration-tests.md)

## Changelog

| Date | Change | PRs |
|------|--------|-----|
| 2026-01-12 | Created task and ADR | #141 |

---

_Last updated: 2026-01-12_
