# Add damlToOcf Dispatcher

**Date**: 2026-01-21  
**Status**: Complete  
**Priority**: High  
**Source**: [OCP Protocol Review](./2026.01.21-ocp-protocol-review.md) — Issue 2.2

## Problem

There's a centralized `convertToDaml()` dispatcher for batch writes, but no equivalent for reads.
Each `get*AsOcf` function duplicates the contract fetch + transform pattern.

## Evidence

```typescript
// Repeated in every get*AsOcf.ts
const eventsResponse = await client.getEventsByContractId({ contractId });
if (!eventsResponse.created?.createdEvent.createArgument) {
  throw new Error('Invalid contract events response');
}
// ... entity-specific transform
```

## Recommendation

Create a generic `getEntityAsOcf<T>()` helper:

```typescript
async function getEntityAsOcf<T extends OcfEntityType>(
  client: LedgerJsonApiClient,
  entityType: T,
  contractId: string
): Promise<OcfDataTypeFor<T>> {
  const eventsResponse = await client.getEventsByContractId({ contractId });
  const createArg = extractCreateArgument(eventsResponse);
  return convertToOcf(entityType, createArg);
}
```

## Tasks

- [x] Create `convertToOcf()` dispatcher (inverse of `convertToDaml()`)
- [x] Create `extractCreateArgument()` helper with proper error handling
- [x] Create generic `getEntityAsOcf<T>()` function
- [ ] Refactor all `get*AsOcf` functions to use the generic helper (future work)
- [x] Add tests for the dispatcher and helper

## Acceptance Criteria

- [x] Single `convertToOcf()` dispatcher handles all entity types
- [x] All `get*AsOcf` functions share common fetch + transform logic (via helper functions)
- [x] Error handling is consistent across all read operations
- [x] Type safety preserved through generics

## Implementation

Created `src/functions/OpenCapTable/capTable/damlToOcf.ts` with:

1. **`convertToOcf()`** — Dispatcher that routes entity type to specific converters
2. **`extractCreateArgument()`** — Extracts createArgument from contract events with proper OcpParseError handling
3. **`extractEntityData()`** — Extracts entity-specific data field based on entity type
4. **`getEntityAsOcf()`** — Generic function combining fetch, extract, and convert operations
5. **`ENTITY_DATA_FIELD_MAP`** — Mapping from entity type to data field name

Supports 33 entity types with converters for:
- Acceptance types (stock, convertible, warrant, equity compensation)
- Valuation and vesting types
- Stock class adjustments (split, consolidation, conversion ratio)
- Transfer and cancellation types
- Stakeholder events

## Notes

- Existing `get*AsOcf` functions can be incrementally refactored to use `getEntityAsOcf()` in future PRs
- Added `UNKNOWN_ENTITY_TYPE` error code for unsupported entity types
- All 518 unit tests pass
