# Add damlToOcf Dispatcher

**Date**: 2026-01-21  
**Status**: Open  
**Priority**: High  
**Source**: [OCP Protocol Review](./2026.01.21-ocp-protocol-review.md) â€” Issue 2.2

## Problem

There's a centralized `convertToDaml()` dispatcher for batch writes, but no equivalent for reads.
Each `get*AsOcf` function duplicates the contract fetch + transform pattern.

## Evidence

```typescript
// Repeated in every get*AsOcf.ts
const eventsResponse = await client.getEventsByContractId({ contractId });
if (!eventsResponse.created?.createdEvent.createArgument) {
  throw new Error('Invalid contract events response');
}
// ... entity-specific transform
```

## Recommendation

Create a generic `getEntityAsOcf<T>()` helper:

```typescript
async function getEntityAsOcf<T extends OcfEntityType>(
  client: LedgerJsonApiClient,
  entityType: T,
  contractId: string
): Promise<OcfDataTypeFor<T>> {
  const eventsResponse = await client.getEventsByContractId({ contractId });
  const createArg = extractCreateArgument(eventsResponse);
  return convertToOcf(entityType, createArg);
}
```

## Tasks

- [ ] Create `convertToOcf()` dispatcher (inverse of `convertToDaml()`)
- [ ] Create `extractCreateArgument()` helper with proper error handling
- [ ] Create generic `getEntityAsOcf<T>()` function
- [ ] Refactor all `get*AsOcf` functions to use the generic helper
- [ ] Add tests for the dispatcher and helper

## Acceptance Criteria

- Single `convertToOcf()` dispatcher handles all entity types
- All `get*AsOcf` functions share common fetch + transform logic
- Error handling is consistent across all read operations
- Type safety preserved through generics
