# New Contract Support

**Date**: 2026-01-12  
**Status**: Open  
**Priority**: High  
**Related PR**: [open-captable-protocol-daml#112](https://github.com/Fairmint/open-captable-protocol-daml/pull/112)

## Overview

Add SDK support for new OCF contracts available in the `@fairmint/open-captable-protocol-daml-js` package. The SDK is currently on version `0.2.68` while the latest package version is `0.2.85`, which includes several new contract types.

## Prerequisites

1. Update `@fairmint/open-captable-protocol-daml-js` to latest version
2. Run `npm install` and verify TypeScript compilation passes

## Unsupported Contracts

The following contracts exist in the DAML package but are not yet supported by the SDK:

### High Priority (Core OCF Types)

| Contract | OCF Type | Data Field | Description |
|----------|----------|------------|-------------|
| Valuation | VALUATION | `valuation_data` | 409A valuations with price per share |
| StockClassSplit | TX_STOCK_CLASS_SPLIT | `split_data` | Stock split events with ratio |
| StockClassConversionRatioAdjustment | TX_STOCK_CLASS_CONVERSION_RATIO_ADJUSTMENT | `adjustment_data` | Conversion ratio changes |
| EquityCompensationRepricing | TX_EQUITY_COMPENSATION_REPRICING | `repricing_data` | Option repricing events |
| WarrantExercise | TX_WARRANT_EXERCISE | `exercise_data` | Warrant exercise transactions |

### Medium Priority (Transaction Events)

| Contract | OCF Type | Data Field | Description |
|----------|----------|------------|-------------|
| ConvertibleConversion | TX_CONVERTIBLE_CONVERSION | `conversion_data` | Convertible note conversions |
| ConvertibleTransfer | TX_CONVERTIBLE_TRANSFER | `transfer_data` | Convertible note transfers |
| StockConversion | TX_STOCK_CONVERSION | `conversion_data` | Stock class conversions |
| StockReissuance | TX_STOCK_REISSUANCE | `reissuance_data` | Stock reissuances |
| StockPlanReturnToPool | TX_STOCK_PLAN_RETURN_TO_POOL | `return_data` | Shares returned to pool |
| StockConsolidation | TX_STOCK_CONSOLIDATION | `consolidation_data` | Stock consolidations |
| EquityCompensationRelease | TX_EQUITY_COMPENSATION_RELEASE | `release_data` | Vested equity releases |
| EquityCompensationTransfer | TX_EQUITY_COMPENSATION_TRANSFER | `transfer_data` | Equity compensation transfers |
| WarrantTransfer | TX_WARRANT_TRANSFER | `transfer_data` | Warrant transfers |

### Lower Priority (Acceptance/Retraction Events)

| Contract | OCF Type | Data Field | Description |
|----------|----------|------------|-------------|
| StockAcceptance | TX_STOCK_ACCEPTANCE | `acceptance_data` | Stock issuance acceptance |
| StockRetraction | TX_STOCK_RETRACTION | `retraction_data` | Stock issuance retraction |
| ConvertibleAcceptance | TX_CONVERTIBLE_ACCEPTANCE | `acceptance_data` | Convertible acceptance |
| ConvertibleRetraction | TX_CONVERTIBLE_RETRACTION | `retraction_data` | Convertible retraction |
| WarrantAcceptance | TX_WARRANT_ACCEPTANCE | `acceptance_data` | Warrant acceptance |
| WarrantRetraction | TX_WARRANT_RETRACTION | `retraction_data` | Warrant retraction |
| EquityCompensationAcceptance | TX_EQUITY_COMPENSATION_ACCEPTANCE | `acceptance_data` | Equity comp acceptance |
| EquityCompensationRetraction | TX_EQUITY_COMPENSATION_RETRACTION | `retraction_data` | Equity comp retraction |

### Vesting Events

| Contract | OCF Type | Data Field | Description |
|----------|----------|------------|-------------|
| VestingStart | TX_VESTING_START | `vesting_data` | Vesting schedule start |
| VestingEvent | TX_VESTING_EVENT | `vesting_data` | Vesting milestone events |
| VestingAcceleration | TX_VESTING_ACCELERATION | `acceleration_data` | Vesting acceleration |

### Stakeholder Events

| Contract | OCF Type | Data Field | Description |
|----------|----------|------------|-------------|
| StakeholderRelationshipChangeEvent | TX_STAKEHOLDER_RELATIONSHIP_CHANGE | `event_data` | Stakeholder relationship changes |
| StakeholderStatusChangeEvent | TX_STAKEHOLDER_STATUS_CHANGE | `event_data` | Stakeholder status changes |

---

## Implementation Pattern

For each new contract type, follow this pattern:

### 1. Create Function Files

```
src/functions/OpenCapTable/{entityName}/
├── create{Entity}.ts           # Create function + buildCreate{Entity}Command
├── get{Entity}AsOcf.ts         # Read function (DAML → OCF)
└── index.ts                    # Barrel export
```

### 2. Create Function Example (`createValuation.ts`)

```typescript
import type { ContractId, ContractDetails, CommandWithDisclosedContracts } from '../../../types';
import type { OcfValuation } from '../../../types/native';

export interface CreateValuationParams {
  issuerContractId: ContractId;
  valuationData: OcfValuation;
  featuredAppRightContractDetails: ContractDetails;
}

export interface CreateValuationResult {
  valuationContractId: ContractId;
}

export function buildCreateValuationCommand(
  params: CreateValuationParams
): CommandWithDisclosedContracts {
  const { valuationData: d } = params;
  
  // Validate required fields
  if (!d.id) throw new Error('valuation.id is required');
  if (!d.effective_date) throw new Error('valuation.effective_date is required');
  // ... more validations
  
  // Build command with explicit field mapping (NO spread)
  const choiceArguments = {
    valuation_data: {
      id: d.id,
      effective_date: dateStringToDAMLTime(d.effective_date),
      price_per_share: monetaryToDaml(d.price_per_share),
      stock_class_id: d.stock_class_id,
      valuation_type: d.valuation_type,
      comments: cleanComments(d.comments),
      board_approval_date: d.board_approval_date 
        ? dateStringToDAMLTime(d.board_approval_date) 
        : null,
      provider: optionalString(d.provider),
      stockholder_approval_date: d.stockholder_approval_date
        ? dateStringToDAMLTime(d.stockholder_approval_date)
        : null,
    },
  };
  
  return { command, disclosedContracts };
}
```

### 3. Add Native Types (`src/types/native.ts`)

```typescript
export interface OcfValuation {
  id: string;
  object_type: 'VALUATION';
  effective_date: string;
  price_per_share: OcfMoney;
  stock_class_id: string;
  valuation_type: 'TX_VALUATION_409A';
  comments?: string[];
  board_approval_date?: string;
  provider?: string;
  stockholder_approval_date?: string;
}
```

### 4. Update OCF Metadata (`src/utils/ocfMetadata.ts`)

```typescript
export type OcfObjectType =
  | 'STOCK_CLASS'
  // ... existing types ...
  | 'VALUATION';  // Add new type

export const OCF_METADATA: Record<OcfObjectType, OcfTypeMetadata> = {
  // ... existing entries ...
  VALUATION: {
    templateId: Fairmint.OpenCapTable.OCF.Valuation.Valuation.templateId,
    ocfIdPath: ['valuation_data', 'id'],
  },
};
```

### 5. Update OCF Helpers (`src/utils/ocfHelpers.ts`)

Add label mapping for the new type:

```typescript
const labelMap: Partial<Record<OcfObjectType, { singular: string; plural: string }>> = {
  // ... existing entries ...
  VALUATION: { singular: 'Valuation', plural: 'Valuations' },
};
```

### 6. Export from Barrel Files

- `src/functions/OpenCapTable/{entityName}/index.ts`
- `src/functions/OpenCapTable/index.ts`
- `src/OcpClient.ts` (add to client facade)

### 7. Add Tests

- Unit test: `test/createOcf/{entity}.test.ts`
- Integration test: `test/integration/entities/{entity}.integration.test.ts`
- Fixture: `test/fixtures/createOcf/{entity}.json`

---

## Implementation Checklist

### Phase 1: Update Dependencies

- [ ] Update `@fairmint/open-captable-protocol-daml-js` to `0.2.85`
- [ ] Run `npm install` and verify build passes
- [ ] Identify any breaking changes

### Phase 2: Core Types (High Priority)

- [ ] Valuation
- [ ] StockClassSplit
- [ ] StockClassConversionRatioAdjustment
- [ ] EquityCompensationRepricing
- [ ] WarrantExercise

### Phase 3: Transaction Events (Medium Priority)

- [ ] ConvertibleConversion
- [ ] ConvertibleTransfer
- [ ] StockConversion
- [ ] StockReissuance
- [ ] StockPlanReturnToPool
- [ ] StockConsolidation
- [ ] EquityCompensationRelease
- [ ] EquityCompensationTransfer
- [ ] WarrantTransfer

### Phase 4: Acceptance/Retraction Events

- [ ] StockAcceptance / StockRetraction
- [ ] ConvertibleAcceptance / ConvertibleRetraction
- [ ] WarrantAcceptance / WarrantRetraction
- [ ] EquityCompensationAcceptance / EquityCompensationRetraction

### Phase 5: Vesting & Stakeholder Events

- [ ] VestingStart
- [ ] VestingEvent
- [ ] VestingAcceleration
- [ ] StakeholderRelationshipChangeEvent
- [ ] StakeholderStatusChangeEvent

---

## Validation Commands

```bash
# After each implementation
npm run fix                   # Auto-fix lint/format
npm run typecheck             # TypeScript check
npm test                      # Unit tests
npm run test:integration      # Integration tests (requires LocalNet)
```

---

## Related Tasks

- [Milestone 2: OCP SDK Implementation](../../../2025/12/2025.12.17-milestone-2-ocp-sdk-implementation.md)
- [Remaining Integration Tests](./2026.01.08-remaining-integration-tests.md)

---

## Changelog

| Date | Change | PRs |
|------|--------|-----|
| 2026-01-12 | Created task for new contract support | — |

---

_Last updated: 2026-01-12_
