# Task: Observability and Tracing Support

## Status: Open

**Created**: 2026-01-16  
**Priority**: Medium  
**Source**: [Canton Network TL;DR Documentation](https://docs.digitalasset.com/build/3.4/overview/tldr.html)

## Summary

Add support for Canton Network observability patterns including correlation identifiers for debugging, 
structured logging integration, and trace propagation across SDK operations.

## Background

The Canton Network documentation emphasizes the importance of correlation identifiers for debugging and 
monitoring distributed applications. Key identifiers include:

| Identifier | Purpose |
|------------|---------|
| ApplicationId | Identifies the ledger client during command submission |
| WorkflowId | Identifies the business process (persisted to ledger) |
| CommandId | Identifies the business "act" associated with a ledger command |
| SubmissionId | Identifies an individual ledger submission |
| TraceId/SpanId | Accepted by GRPC/HTTP interfaces for distributed tracing |
| TransactionId | Global identifier for committed transactions |
| ContractId | Global identifier for created contracts |

Currently, the SDK does not provide explicit support for:
- Passing custom correlation IDs with commands
- Propagating trace context across operations
- Structured logging with correlation IDs
- Metrics collection integration

## Implementation Steps

### Phase 1: Command Context Support

1. **Add command context interface**:
   ```typescript
   export interface CommandContext {
     /** Identifies the business process. Persisted to ledger. */
     workflowId?: string;
     /** Identifies the individual command. Must be unique per command. */
     commandId?: string;
     /** Identifies the submission attempt. Used for retry detection. */
     submissionId?: string;
     /** OpenTelemetry trace context for distributed tracing */
     traceContext?: {
       traceId: string;
       spanId: string;
     };
   }
   ```

2. **Update SDK function signatures** to accept optional context:
   ```typescript
   export interface CreateIssuerParams {
     // ... existing params
     /** Optional context for tracing and debugging */
     context?: CommandContext;
   }
   ```

3. **Pass context to underlying Canton client** when executing commands

### Phase 2: Logging Integration

1. **Add logger interface** that SDK consumers can implement:
   ```typescript
   export interface SdkLogger {
     debug(message: string, context?: Record<string, unknown>): void;
     info(message: string, context?: Record<string, unknown>): void;
     warn(message: string, context?: Record<string, unknown>): void;
     error(message: string, context?: Record<string, unknown>): void;
   }
   ```

2. **Add logging hooks** at key points:
   - Before command submission
   - After successful command execution
   - On command failure (with error details)
   - Contract creation events

3. **Include correlation IDs** in all log messages

### Phase 3: Metrics Support (Optional)

1. **Define metrics interface**:
   ```typescript
   export interface SdkMetrics {
     commandSubmitted(templateId: string, choice: string): void;
     commandSucceeded(templateId: string, choice: string, durationMs: number): void;
     commandFailed(templateId: string, choice: string, errorType: string): void;
   }
   ```

2. **Add hooks for metrics collection** at command execution points

### Phase 4: OcpClient Configuration

1. **Extend OcpClient constructor options**:
   ```typescript
   export interface OcpClientOptions {
     // ... existing options
     logger?: SdkLogger;
     metrics?: SdkMetrics;
     /** Default context applied to all commands */
     defaultContext?: Partial<CommandContext>;
   }
   ```

## Testing Requirements

- [ ] Unit tests for context propagation
- [ ] Unit tests for logging hooks
- [ ] Integration tests verifying correlation IDs reach the ledger
- [ ] Documentation for how to integrate with common logging frameworks
- [ ] Example usage with OpenTelemetry

## Acceptance Criteria

- [ ] SDK accepts optional CommandContext on all write operations
- [ ] Context is properly passed to Canton node SDK
- [ ] Logger interface can be plugged in by consumers
- [ ] Correlation IDs appear in ledger commands
- [ ] Documentation updated with observability guidance

## Related Documentation

- [Canton Observability Overview](https://docs.digitalasset.com/build/3.4/quickstart/observe/observability-troubleshooting-overview.html)
- [CN Quickstart Development Journey](https://docs.digitalasset.com/build/3.4/quickstart/configure/dev-journey-in-cnqs-lifecycle.html)

## Notes

This is a non-breaking change. All new parameters are optional, maintaining backwards compatibility 
with existing SDK consumers.
