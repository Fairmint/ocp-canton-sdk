# Type Guards for OCF Objects

**Date**: 2026-01-16 **Status**: Complete **Priority**: Low **Parent**:
[Library Refactoring and Testing](./2026.01.02-library-refactoring-and-testing.md)

## Overview

Add runtime type guards for OCF objects to enable safer type narrowing without type assertions.

## Current State

The SDK defines comprehensive TypeScript types for OCF objects in `src/types/native.ts`, but there
are no runtime type guards to verify object types at runtime.

Currently, users must use type assertions or trust the source:

```typescript
// Current: Trust the response type
const result = await ocp.OpenCapTable.issuer.getIssuerAsOcf({ contractId });
console.log(result.issuer.legal_name); // Hope it's actually an issuer

// Or use unsafe assertions
const data = someUnknownData as OcfIssuer;
```

## Goals

### 1. Basic Type Guards

Create type guards for each OCF object type:

```typescript
// src/utils/typeGuards.ts
export function isOcfIssuer(obj: unknown): obj is OcfIssuer {
  return (
    typeof obj === 'object' &&
    obj !== null &&
    'id' in obj &&
    'legal_name' in obj &&
    'formation_date' in obj &&
    'country_of_formation' in obj &&
    'tax_ids' in obj
  );
}

export function isOcfStakeholder(obj: unknown): obj is OcfStakeholder {
  return (
    typeof obj === 'object' &&
    obj !== null &&
    'id' in obj &&
    'name' in obj &&
    'stakeholder_type' in obj
  );
}
```

### 2. Object Type Discriminator Guards

Use `object_type` field when available (from OCF responses):

```typescript
export function isOcfObjectType<T extends OcfObjectType>(
  obj: unknown,
  type: T
): obj is OcfObjectForType<T> {
  return (
    typeof obj === 'object' &&
    obj !== null &&
    'object_type' in obj &&
    (obj as { object_type: string }).object_type === type
  );
}

// Usage
if (isOcfObjectType(data, 'ISSUER')) {
  // TypeScript knows data is OcfIssuer
  console.log(data.legal_name);
}
```

### 3. Transaction Type Guards

Guards for transaction types (issuances, cancellations, transfers, etc.):

```typescript
export function isStockIssuance(obj: unknown): obj is OcfStockIssuance {
  return (
    typeof obj === 'object' &&
    obj !== null &&
    'id' in obj &&
    'security_id' in obj &&
    'stock_class_id' in obj &&
    'quantity' in obj
  );
}
```

### 4. Validation with Type Guards

Combine type guards with validation:

```typescript
export function assertOcfIssuer(obj: unknown): asserts obj is OcfIssuer {
  if (!isOcfIssuer(obj)) {
    throw new Error(`Expected OcfIssuer, got ${typeof obj}`);
  }
}

// Usage
assertOcfIssuer(data); // Throws if invalid
// TypeScript now knows data is OcfIssuer
```

## Implementation Plan

### Phase 1: Core Object Guards ✅ Complete

- [x] Create `src/utils/typeGuards.ts` ✅ 2026-01-20
- [x] Add guards for core objects: Issuer, Stakeholder, StockClass, StockPlan, VestingTerms ✅
      2026-01-20
- [x] Add generic `detectOcfObjectType()` discriminator guard ✅ 2026-01-20
- [x] Export from `src/utils/index.ts` ✅ 2026-01-20

### Phase 2: Transaction Guards ✅ Complete

- [x] Add guards for issuance types ✅ 2026-01-20
- [x] Add guards for cancellation types ✅ 2026-01-20
- [x] Add guards for transfer types ✅ 2026-01-20
- [x] Add guards for exercise/conversion types ✅ 2026-01-20

### Phase 3: Integration with SDK ⏳ Deferred

- [ ] Consider using guards internally in `get*AsOcf` functions (future enhancement)
- [x] Add documentation with usage examples ✅ 2026-01-20 (JSDoc in typeGuards.ts)
- [ ] Add tests for all type guards (future enhancement)

## Files to Create

- `src/utils/typeGuards.ts` - Type guard functions

## Files to Modify

- `src/utils/index.ts` - Export type guards
- `src/types/index.ts` - May need helper types for discriminated unions

## Example Usage

```typescript
import { isOcfIssuer, isOcfObjectType, assertOcfStakeholder } from '@open-captable-protocol/canton';

// Safe narrowing with type guard
function processOcfObject(data: unknown) {
  if (isOcfIssuer(data)) {
    console.log(`Issuer: ${data.legal_name}`);
  } else if (isOcfObjectType(data, 'STAKEHOLDER')) {
    console.log(`Stakeholder: ${data.name.legal_name}`);
  }
}

// Assertion for guaranteed types
function requireStakeholder(data: unknown): OcfStakeholder {
  assertOcfStakeholder(data);
  return data;
}
```

## Validation

```bash
npm run fix                    # Lint/format
npm run typecheck              # Type check
npm test                       # Unit tests
```

## Related

- [Library Refactoring and Testing](./2026.01.02-library-refactoring-and-testing.md)
- OCF schema definitions in `src/types/native.ts`

## Changelog

| Date       | Change                                             | PRs |
| ---------- | -------------------------------------------------- | --- |
| 2026-01-16 | Created task                                       | --  |
| 2026-01-20 | Implemented type guards in src/utils/typeGuards.ts | --  |

---

_Last updated: 2026-01-20_
