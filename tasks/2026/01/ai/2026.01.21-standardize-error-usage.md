# Standardize Error Usage

**Date**: 2026-01-21  
**Status**: Completed  
**Priority**: Medium  
**Source**: [OCP Protocol Review](./2026.01.21-ocp-protocol-review.md) — Issue 4.1  
**Completed**: 2026-01-22

## Problem

The SDK has well-defined error types (`OcpValidationError`, `OcpContractError`, `OcpParseError`,
`OcpNetworkError`) but they're not consistently used throughout the codebase.

## Evidence

```typescript
// Some functions use OcpValidationError
throw new OcpValidationError('issuer.id', 'Required field is missing', { ... });

// Others use plain Error
throw new Error('Invalid contract events response');
```

## Recommendation

Audit all `throw new Error()` calls and replace with appropriate OCP error types:

- `OcpValidationError` — for input validation failures
- `OcpContractError` — for DAML contract/ledger errors
- `OcpParseError` — for data transformation errors
- `OcpNetworkError` — for network/connectivity errors

## Tasks

- [x] Search codebase for all `throw new Error()` calls
- [x] Categorize each error by appropriate OCP error type
- [x] Replace with OCP error types with proper context
- [x] Add error context for batch operations (which entity failed)
- [x] Update tests to verify correct error types are thrown

## Acceptance Criteria

- [x] No `throw new Error()` in SDK source code
- [x] All errors include relevant context (field path, contract ID, etc.)
- [x] Batch errors include which entity caused the failure
- [x] Tests verify error types and context

## Implementation Summary

All 64+ instances of `throw new Error()` across the SDK source code have been replaced with
appropriate OCP error types:

### Error Type Categories Used

1. **OcpValidationError** — Used for:
   - Missing required fields (with `OcpErrorCodes.REQUIRED_FIELD_MISSING`)
   - Invalid field formats (with `OcpErrorCodes.INVALID_FORMAT`)
   - Type mismatches (with `OcpErrorCodes.INVALID_TYPE`)
   - Context includes: `fieldPath`, `expectedType`, `receivedValue`

2. **OcpContractError** — Used for:
   - Missing contract events or create arguments (with `OcpErrorCodes.RESULT_NOT_FOUND`)
   - Contract not found errors (with `OcpErrorCodes.CONTRACT_NOT_FOUND`)
   - Context includes: `contractId`, `templateId`, `choice`

3. **OcpParseError** — Used for:
   - Unknown enum values (with `OcpErrorCodes.UNKNOWN_ENUM_VALUE`)
   - Schema mismatches (with `OcpErrorCodes.SCHEMA_MISMATCH`)
   - Context includes: `source`

### Files Modified (64+ files across the codebase)

- **Utils**: `typeGuards.ts`, `enumConversions.ts`
- **Core**: `OcpClient.ts`
- **Extensions**: `PaymentStreamsExtension.ts`
- **Functions**: All `get*AsOcf.ts` and `create*.ts` files
- **PaymentStreams**: `disclosedContracts.ts`, `factoryContractId.ts`, `paymentContext.ts`
- **CouponMinter**: `canMintCouponsNow.ts`
- **Reports**: `companyValuationReport/*.ts`

### Verification

- `npm run typecheck` passes with no errors
- `npm run lint` passes with no warnings
