# Remaining Integration Tests

**Date**: 2026-01-08  
**Status**: Partially Complete  
**Priority**: Medium

## Overview

This task documents the remaining skipped integration tests in the `ocp-canton-sdk` and the blockers
preventing their implementation.

## Summary

| Category                  | Count | Status                                   |
| ------------------------- | ----- | ---------------------------------------- |
| Entity Archive Operations | 13    | ✅ **COMPLETED** (2026-01-12)            |
| Payment/Airdrop Workflows | 2     | Requires amulet infrastructure           |
| Payment Stream Workflows  | 5     | Requires payment stream infrastructure   |
| Reports                   | 1     | OCP Factory initialization issue         |

**Remaining Skipped Tests: 8** (down from 21)

---

## Category 1: Entity Archive Operations (13 tests) ✅ COMPLETED

### Resolution

All 13 entity delete/archive operations have been implemented and the tests are now enabled.

**Changes made:**

1. Created `buildDelete*Command` functions for all 13 entity types:
   - `deleteStockIssuance.ts`
   - `deleteStockPlan.ts`
   - `deleteStockLegendTemplate.ts`
   - `deleteStockPlanPoolAdjustment.ts`
   - `deleteStockClassAuthorizedSharesAdjustment.ts`
   - `deleteVestingTerms.ts`
   - `deleteDocument.ts`
   - `deleteConvertibleIssuance.ts`
   - `deleteEquityCompensationIssuance.ts`
   - `deleteStockTransfer.ts`
   - `deleteIssuerAuthorizedSharesAdjustment.ts`
   - `deleteWarrantIssuance.ts`
   - `deleteStockCancellation.ts`

2. Exported delete functions from entity index files
3. Exposed delete commands in `OcpClient.ts`
4. Updated all 13 integration tests to use the new delete commands

### Enabled Tests

| File                                                       | Test Name                                |
| ---------------------------------------------------------- | ---------------------------------------- |
| `stockIssuance.integration.test.ts`                        | deletes stock issuance                   |
| `stockPlan.integration.test.ts`                            | deletes stock plan                       |
| `stockLegendTemplate.integration.test.ts`                  | deletes stock legend template            |
| `stockPlanPoolAdjustment.integration.test.ts`              | deletes stock plan pool adjustment       |
| `stockClassAuthorizedSharesAdjustment.integration.test.ts` | deletes adjustment                       |
| `vestingTerms.integration.test.ts`                         | deletes vesting terms                    |
| `document.integration.test.ts`                             | deletes document                         |
| `convertibleIssuance.integration.test.ts`                  | deletes convertible issuance             |
| `equityCompensationIssuance.integration.test.ts`           | deletes equity compensation issuance     |
| `stockTransfer.integration.test.ts`                        | deletes stock transfer                   |
| `issuerAuthorizedSharesAdjustment.integration.test.ts`     | deletes issuer authorized shares adj.    |
| `warrantIssuance.integration.test.ts`                      | deletes warrant issuance                 |
| `stockCancellation.integration.test.ts`                    | deletes stock cancellation               |

---

## Category 2: Payment/Airdrop Workflows (2 tests)

### Blocker

These tests require Canton Network with full amulet infrastructure (Canton Coin/amulet support)
which is not available in the LocalNet test environment.

### Affected Tests

| File                                         | Test Name                    |
| -------------------------------------------- | ---------------------------- |
| `payments/simpleAirdrop.integration.test.ts` | full simple airdrop workflow |
| `payments/airdrop.integration.test.ts`       | full airdrop workflow        |

### Resolution Path

1. Set up a test environment with amulet support OR
2. Mock the amulet infrastructure for testing OR
3. Accept as integration tests that can only run against a full Canton Network

---

## Category 3: Payment Stream Workflows (5 tests)

### Blocker

These tests require payment stream infrastructure which involves:

- Active payment streams with configured payment schedules
- Amulet transfers for payment execution
- Multi-party authorization flows

### Affected Tests

| File                                                      | Test Name                             |
| --------------------------------------------------------- | ------------------------------------- |
| `streams/paymentStreamChangeProposal.integration.test.ts` | full change proposal workflow         |
| `streams/activePaymentStream.integration.test.ts`         | full active payment stream workflow   |
| `streams/proposedPaymentStream.integration.test.ts`       | full proposed payment stream workflow |
| `streams/partyMigrationProposal.integration.test.ts`      | full party migration workflow         |
| `streams/paymentStreamFactory.integration.test.ts`        | full payment stream proposal workflow |

### Resolution Path

1. Set up payment stream infrastructure in LocalNet OR
2. Create mocked payment stream contracts for testing OR
3. Accept as integration tests requiring specialized environment

---

## Category 4: Reports (1 test)

### Blocker

The company valuation report workflow test requires OCP Factory initialization which may have
additional setup requirements.

### Affected Tests

| File                                                 | Test Name                       |
| ---------------------------------------------------- | ------------------------------- |
| `reports/companyValuationReport.integration.test.ts` | full company valuation workflow |

### Resolution Path

1. Investigate OCP Factory setup requirements
2. Determine if additional contracts need deployment
3. Enable test once factory is properly initialized

---

## Recommendations

### Short-term (Enable more tests)

1. **Expose delete commands** - This would enable 13 additional tests with minimal effort
2. **Review factory setup** - May enable the valuation report test

### Long-term (Full coverage)

1. **Payment infrastructure** - Consider adding payment stream support to LocalNet
2. **Amulet mocking** - Create mock implementations for airdrop testing

---

## Related Files

- `test/integration/entities/*.integration.test.ts` - Entity tests
- `test/integration/payments/*.integration.test.ts` - Payment tests
- `test/integration/streams/*.integration.test.ts` - Stream tests
- `test/integration/reports/*.integration.test.ts` - Report tests

## Test Status (as of 2026-01-12)

- **Total test suites**: 28
- **Passed tests**: 70 (up from 57)
- **Skipped tests**: 8 (down from 21)
- **Failed tests**: 0

### Changelog

**2026-01-12**: Implemented delete commands for all 13 entity types and enabled their integration tests.
- Added 13 new `buildDelete*Command` functions in `src/functions/OpenCapTable/`
- Exposed all delete commands in `OcpClient.ts`
- Updated 13 integration tests from `test.skip` to active tests
