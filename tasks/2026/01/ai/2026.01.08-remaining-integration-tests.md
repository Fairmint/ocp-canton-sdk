# Remaining Integration Tests

**Date**: 2026-01-08  
**Status**: Open  
**Priority**: Medium

## Overview

This task documents the remaining skipped integration tests in the `ocp-canton-sdk` and the blockers
preventing their implementation.

## Summary

| Category                  | Count | Blocker                                  |
| ------------------------- | ----- | ---------------------------------------- |
| Entity Archive Operations | 13    | Delete commands not exposed in OcpClient |
| Payment/Airdrop Workflows | 2     | Requires amulet infrastructure           |
| Payment Stream Workflows  | 5     | Requires payment stream infrastructure   |
| Reports                   | 1     | OCP Factory initialization issue         |

**Total Skipped Tests: 21**

---

## Category 1: Entity Archive Operations (13 tests)

### Blocker

Archive/delete operations require `buildDelete*Command` functions to be exposed in the `OcpClient`.
Currently, only create and edit operations are available in the public API.

### Affected Tests

| File                                                       | Test Name                                    | Required Function                                        |
| ---------------------------------------------------------- | -------------------------------------------- | -------------------------------------------------------- |
| `stockIssuance.integration.test.ts`                        | archives stock issuance                      | `buildDeleteStockIssuanceCommand`                        |
| `stockPlan.integration.test.ts`                            | archives stock plan                          | `buildDeleteStockPlanCommand`                            |
| `stockLegendTemplate.integration.test.ts`                  | archives stock legend template               | `buildDeleteStockLegendTemplateCommand`                  |
| `stockPlanPoolAdjustment.integration.test.ts`              | archives stock plan pool adjustment          | `buildDeleteStockPlanPoolAdjustmentCommand`              |
| `stockClassAuthorizedSharesAdjustment.integration.test.ts` | archives adjustment                          | `buildDeleteStockClassAuthorizedSharesAdjustmentCommand` |
| `vestingTerms.integration.test.ts`                         | archives vesting terms                       | `buildDeleteVestingTermsCommand`                         |
| `document.integration.test.ts`                             | archives document                            | `buildDeleteDocumentCommand`                             |
| `convertibleIssuance.integration.test.ts`                  | archives convertible issuance                | `buildDeleteConvertibleIssuanceCommand`                  |
| `equityCompensationIssuance.integration.test.ts`           | archives equity compensation issuance        | `buildDeleteEquityCompensationIssuanceCommand`           |
| `stockTransfer.integration.test.ts`                        | archives stock transfer                      | `buildDeleteStockTransferCommand`                        |
| `issuerAuthorizedSharesAdjustment.integration.test.ts`     | archives issuer authorized shares adjustment | `buildDeleteIssuerAuthorizedSharesAdjustmentCommand`     |
| `warrantIssuance.integration.test.ts`                      | archives warrant issuance                    | `buildDeleteWarrantIssuanceCommand`                      |
| `stockCancellation.integration.test.ts`                    | archives stock cancellation                  | `buildDeleteStockCancellationCommand`                    |

### Resolution Path

1. Review DAML contracts to confirm archive/delete choices exist
2. Implement `buildDelete*Command` functions for each entity type
3. Expose delete functions in `OcpClient`
4. Enable and verify archive tests

---

## Category 2: Payment/Airdrop Workflows (2 tests)

### Blocker

These tests require Canton Network with full amulet infrastructure (Canton Coin/amulet support)
which is not available in the LocalNet test environment.

### Affected Tests

| File                                         | Test Name                    |
| -------------------------------------------- | ---------------------------- |
| `payments/simpleAirdrop.integration.test.ts` | full simple airdrop workflow |
| `payments/airdrop.integration.test.ts`       | full airdrop workflow        |

### Resolution Path

1. Set up a test environment with amulet support OR
2. Mock the amulet infrastructure for testing OR
3. Accept as integration tests that can only run against a full Canton Network

---

## Category 3: Payment Stream Workflows (5 tests)

### Blocker

These tests require payment stream infrastructure which involves:

- Active payment streams with configured payment schedules
- Amulet transfers for payment execution
- Multi-party authorization flows

### Affected Tests

| File                                                      | Test Name                             |
| --------------------------------------------------------- | ------------------------------------- |
| `streams/paymentStreamChangeProposal.integration.test.ts` | full change proposal workflow         |
| `streams/activePaymentStream.integration.test.ts`         | full active payment stream workflow   |
| `streams/proposedPaymentStream.integration.test.ts`       | full proposed payment stream workflow |
| `streams/partyMigrationProposal.integration.test.ts`      | full party migration workflow         |
| `streams/paymentStreamFactory.integration.test.ts`        | full payment stream proposal workflow |

### Resolution Path

1. Set up payment stream infrastructure in LocalNet OR
2. Create mocked payment stream contracts for testing OR
3. Accept as integration tests requiring specialized environment

---

## Category 4: Reports (1 test)

### Blocker

The company valuation report workflow test requires OCP Factory initialization which may have
additional setup requirements.

### Affected Tests

| File                                                 | Test Name                       |
| ---------------------------------------------------- | ------------------------------- |
| `reports/companyValuationReport.integration.test.ts` | full company valuation workflow |

### Resolution Path

1. Investigate OCP Factory setup requirements
2. Determine if additional contracts need deployment
3. Enable test once factory is properly initialized

---

## Recommendations

### Short-term (Enable more tests)

1. **Expose delete commands** - This would enable 13 additional tests with minimal effort
2. **Review factory setup** - May enable the valuation report test

### Long-term (Full coverage)

1. **Payment infrastructure** - Consider adding payment stream support to LocalNet
2. **Amulet mocking** - Create mock implementations for airdrop testing

---

## Related Files

- `test/integration/entities/*.integration.test.ts` - Entity tests
- `test/integration/payments/*.integration.test.ts` - Payment tests
- `test/integration/streams/*.integration.test.ts` - Stream tests
- `test/integration/reports/*.integration.test.ts` - Report tests

## Test Status (as of 2026-01-08)

- **Total test suites**: 28
- **Passed tests**: 57
- **Skipped tests**: 21
- **Failed tests**: 0
