# Converter File Organization Pattern

**Date**: 2026-01-21 **Status**: Open **Priority**: High **Parent**:
[Milestone 2: OCP SDK Implementation](../../12/2025.12.17-milestone-2-ocp-sdk-implementation.md)

## Problem Statement

Recent PRs (#183-#188) implementing new OCF types have been placing converter implementations
directly in `capTable/damlToOcf.ts`, creating a bloated file that violates the established SDK
architecture.

### Current Anti-Pattern (PRs #183-#188)

```typescript
// capTable/damlToOcf.ts - WRONG: Implementations inline
export function damlStockAcceptanceToNative(d: DamlAcceptanceData): OcfStockAcceptance {
  return {
    id: d.id,
    date: damlTimeToDateString(d.date),
    // ... full implementation here
  };
}
```

### Established Pattern (Existing Code)

The SDK already has a well-established pattern:

```
src/functions/OpenCapTable/
├── capTable/
│   └── ocfToDaml.ts        # DISPATCHER ONLY - imports from entity folders
├── stakeholder/
│   ├── stakeholderDataToDaml.ts   # OCF→DAML converter
│   ├── getStakeholderAsOcf.ts     # DAML→OCF converter
│   └── index.ts
├── stockTransfer/
│   ├── createStockTransfer.ts     # Includes stockTransferDataToDaml
│   ├── getStockTransferAsOcf.ts   # DAML→OCF converter
│   └── index.ts
└── ...
```

**Key insight**: `capTable/ocfToDaml.ts` is a **dispatcher** that imports converter functions from
entity folders. It does NOT contain implementations (except for types that haven't been migrated
yet).

## Correct Architecture

### 1. Entity Folder Structure

Each OCF entity type should have its own folder containing:

```
src/functions/OpenCapTable/{entityType}/
├── {entityType}DataToDaml.ts   # OCF→DAML converter (for batch API)
├── get{EntityType}AsOcf.ts     # DAML→OCF converter (for reads)
├── create{EntityType}.ts       # Optional: standalone create function
└── index.ts                    # Exports all functions
```

### 2. Dispatcher Files (capTable/)

The `capTable/` folder should contain **dispatchers only**:

```typescript
// capTable/ocfToDaml.ts - DISPATCHER
import { stakeholderDataToDaml } from '../stakeholder/stakeholderDataToDaml';
import { stockAcceptanceDataToDaml } from '../stockAcceptance/stockAcceptanceDataToDaml';
// ... imports from entity folders

export function convertToDaml(type: OcfEntityType, data: OcfEntityData): unknown {
  switch (type) {
    case 'stakeholder':
      return stakeholderDataToDaml(data);
    case 'stockAcceptance':
      return stockAcceptanceDataToDaml(data);
    // ... routes to imported functions
  }
}
```

```typescript
// capTable/damlToOcf.ts - DISPATCHER (to be created)
import { damlStakeholderToNative } from '../stakeholder/getStakeholderAsOcf';
import { damlStockAcceptanceToNative } from '../stockAcceptance/getStockAcceptanceAsOcf';
// ... imports from entity folders

export function convertFromDaml<T extends OcfEntityType>(
  type: T,
  damlData: DamlDataTypeFor<T>
): OcfDataTypeFor<T> {
  switch (type) {
    case 'stakeholder':
      return damlStakeholderToNative(damlData);
    // ... routes to imported functions
  }
}
```

### 3. Shared Utilities Location

Common conversion utilities belong in `src/utils/`:

```
src/utils/
├── typeConversions.ts     # damlTimeToDateString, normalizeNumericString, etc.
├── enumConversions.ts     # All enum mappings (already exists)
└── validation.ts          # Shared validation functions
```

## Tasks

### Phase 1: Update New PRs (Immediate)

PRs #183-#188 need to be updated to follow the correct pattern:

- [ ] PR #183 (Transfer Types): Move converters to entity folders
- [ ] PR #184 (Acceptance Types): Move converters to entity folders
- [ ] PR #185 (Exercise/Conversion Types): Already uses entity folders ✓
- [ ] PR #186 (Stock Class Adjustments): Move converters to entity folders
- [ ] PR #187 (Valuation/Vesting Types): Move converters to entity folders
- [ ] PR #188 (Remaining Types): Move converters to entity folders, move enum converters to
      `enumConversions.ts`, add `OcpClient` methods

### Phase 2: Clean Up ocfToDaml.ts (Follow-up)

The existing `ocfToDaml.ts` has inline implementations that need migration:

- [ ] Extract `stockAcceptanceDataToDaml` to `stockAcceptance/stockAcceptanceDataToDaml.ts`
- [ ] Extract `warrantAcceptanceDataToDaml` to `warrantAcceptance/warrantAcceptanceDataToDaml.ts`
- [ ] Extract `convertibleAcceptanceDataToDaml` to `convertibleAcceptance/`
- [ ] Extract `equityCompensationAcceptanceDataToDaml` to `equityCompensationAcceptance/`
- [ ] Extract all remaining inline converters (~30 functions)
- [ ] Ensure `ocfToDaml.ts` is dispatcher-only

### Phase 3: Create damlToOcf.ts Dispatcher

- [ ] Create `capTable/damlToOcf.ts` as a dispatcher that imports from entity folders
- [ ] Add type-safe generic dispatcher function
- [ ] Export convenience functions for batch reads (future)

## File Organization Checklist

For each new OCF entity type, verify:

- [ ] Entity folder exists: `src/functions/OpenCapTable/{entityType}/`
- [ ] OCF→DAML converter in entity folder (not in `capTable/ocfToDaml.ts`)
- [ ] DAML→OCF converter in entity folder (not in `capTable/damlToOcf.ts`)
- [ ] `index.ts` exports all converters
- [ ] `OcpClient.ts` has `get{EntityType}AsOcf` method wired
- [ ] Unit tests in `test/converters/{entityType}Converters.test.ts`
- [ ] Integration tests in `test/integration/entities/{entityType}.integration.test.ts`

## Benefits of This Architecture

1. **Discoverability**: All code for an entity is in one folder
2. **Maintainability**: Changes to an entity only affect its folder
3. **Scalability**: Adding new entities doesn't bloat central files
4. **Testability**: Entity-specific tests alongside entity code
5. **Code Review**: PRs for new entities are self-contained

## Validation

```bash
npm run fix                    # Lint/format
npm run typecheck              # Type check
npm test                       # Unit tests
npm run test:integration       # Integration tests
```

## Related

- [Consolidate Entity Converters](./2026.01.16-consolidate-entity-converters.md)
- [Batch Cap Table Updates](./2026.01.12-batch-cap-table-updates.md)
- [Library Refactoring and Testing](./2026.01.02-library-refactoring-and-testing.md)

## Changelog

| Date       | Change                                                  | PRs |
| ---------- | ------------------------------------------------------- | --- |
| 2026-01-21 | Created task after reviewing PRs #183-#188 architecture | —   |

---

_Last updated: 2026-01-21_
