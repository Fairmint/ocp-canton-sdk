# Task: Command Tracking and Retry Logic

## Status: Open

**Created**: 2026-01-16  
**Priority**: Medium  
**Source**: [Canton Network TL;DR Documentation](https://docs.digitalasset.com/build/3.4/overview/tldr.html)

## Summary

Implement robust command tracking and retry logic following Canton Network best practices for
handling transient failures, network issues, and command deduplication.

## Background

The Canton Network documentation and CN Quickstart patterns emphasize:

1. **Command deduplication**: Using unique CommandIds to ensure exactly-once semantics
2. **Submission tracking**: Using SubmissionIds to detect and handle retry scenarios
3. **Transient failure handling**: Network issues, temporary service unavailability
4. **Idempotent operations**: Ensuring retries don't cause duplicate side effects

Currently, the SDK:

- Does not generate or track CommandIds/SubmissionIds
- Does not implement retry logic for transient failures
- Does not provide command completion tracking utilities

## Implementation Steps

### Phase 1: Command ID Generation

1. **Add utility for generating unique command IDs**:

   ```typescript
   export function generateCommandId(): string {
     return crypto.randomUUID();
   }

   export function generateSubmissionId(): string {
     return crypto.randomUUID();
   }
   ```

2. **Auto-generate IDs** when not provided by caller

3. **Return IDs in result** for tracking:
   ```typescript
   export interface CommandResult<T> {
     data: T;
     commandId: string;
     submissionId: string;
     transactionId?: string;
   }
   ```

### Phase 2: Retry Configuration

1. **Add retry configuration interface**:

   ```typescript
   export interface RetryConfig {
     /** Maximum number of retry attempts (default: 3) */
     maxAttempts?: number;
     /** Initial delay in ms (default: 1000) */
     initialDelayMs?: number;
     /** Maximum delay in ms (default: 30000) */
     maxDelayMs?: number;
     /** Exponential backoff multiplier (default: 2) */
     backoffMultiplier?: number;
     /** Jitter factor 0-1 to randomize delays (default: 0.1) */
     jitterFactor?: number;
     /** Predicate to determine if error is retryable */
     isRetryable?: (error: Error) => boolean;
   }
   ```

2. **Default retryable conditions**:
   - Network errors (connection refused, timeout)
   - HTTP 503 Service Unavailable
   - HTTP 429 Too Many Requests
   - gRPC UNAVAILABLE status

### Phase 3: Retry Implementation

1. **Create retry wrapper**:

   ```typescript
   export async function withRetry<T>(
     operation: () => Promise<T>,
     config?: RetryConfig
   ): Promise<T> {
     // Implement exponential backoff with jitter
   }
   ```

2. **Integrate retry logic** into command submission flow

3. **Emit events** on retry attempts (for logging/metrics)

### Phase 4: Command Completion Tracking

1. **Add completion status types**:

   ```typescript
   export type CommandStatus = 'PENDING' | 'SUBMITTED' | 'SUCCEEDED' | 'FAILED' | 'TIMEOUT';

   export interface CommandCompletion {
     commandId: string;
     status: CommandStatus;
     transactionId?: string;
     error?: Error;
     attemptCount: number;
   }
   ```

2. **Track command lifecycle** from submission to completion

3. **Support async completion queries** for long-running commands

### Phase 5: OcpClient Integration

1. **Add retry config to client options**:

   ```typescript
   export interface OcpClientOptions {
     // ... existing options
     retry?: RetryConfig;
     /** Whether to auto-generate command IDs (default: true) */
     autoGenerateIds?: boolean;
   }
   ```

2. **Per-operation override** support:
   ```typescript
   await client.createIssuer({
     ...params,
     retry: { maxAttempts: 5 },
   });
   ```

## Testing Requirements

- [ ] Unit tests for retry logic with exponential backoff
- [ ] Unit tests for command ID generation
- [ ] Unit tests for retryable error detection
- [ ] Integration tests simulating transient failures
- [ ] Test command deduplication behavior

## Acceptance Criteria

- [ ] Commands automatically have unique CommandIds/SubmissionIds
- [ ] Transient failures are retried with exponential backoff
- [ ] Retry behavior is configurable at client and operation level
- [ ] Command completion can be tracked
- [ ] Documentation covers retry behavior and configuration

## Related Documentation

- [Canton JSON API](https://docs.digitalasset.com/build/3.4/reference/json-api/openapi.html)
- [CN Quickstart FAQ - Common Issues](https://docs.digitalasset.com/build/3.4/quickstart/troubleshoot/cnqs-faq.html)

## Notes

- Ensure retry logic is idempotent - same CommandId should be used across retries
- Consider circuit breaker pattern for repeated failures
- Log all retry attempts with context for debugging
