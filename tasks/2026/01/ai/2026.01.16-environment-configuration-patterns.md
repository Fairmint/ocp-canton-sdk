# Task: Environment Configuration Patterns

## Status: Open

**Created**: 2026-01-16  
**Priority**: Medium  
**Source**: [Canton Network TL;DR Documentation](https://docs.digitalasset.com/build/3.4/overview/tldr.html)

## Summary

Improve SDK configuration patterns to support different deployment environments (LocalNet, DevNet, 
TestNet, MainNet) with environment-specific defaults, validation, and documentation.

## Background

The Canton Network operates across multiple environments:

| Environment | Purpose | Characteristics |
|-------------|---------|-----------------|
| **LocalNet** | Local development | Docker-based, all services local |
| **ScratchNet** | Team development | Persistent LocalNet-like environment |
| **DevNet** | Integration testing | Public test network |
| **TestNet** | Pre-production | Closer to production config |
| **MainNet** | Production | Real Canton Coin, production SLAs |

Each environment has different:
- API endpoints (ports, hostnames)
- Authentication modes (shared-secret vs OAuth2)
- Network configuration
- Rate limits and quotas

Currently, the SDK:
- Requires manual configuration of all endpoints
- Doesn't validate configuration for specific environments
- No environment presets or helpers

## Implementation Steps

### Phase 1: Environment Presets

1. **Define environment configuration types**:
   ```typescript
   export type Environment = 'localnet' | 'scratchnet' | 'devnet' | 'testnet' | 'mainnet' | 'custom';
   
   export interface EnvironmentConfig {
     environment: Environment;
     ledgerApiUrl: string;
     validatorApiUrl?: string;
     authMode: 'shared-secret' | 'oauth2';
     // OAuth2 specific
     authUrl?: string;
     clientId?: string;
     clientSecret?: string;
   }
   ```

2. **Add environment presets**:
   ```typescript
   export const LOCALNET_PRESET: Partial<EnvironmentConfig> = {
     environment: 'localnet',
     ledgerApiUrl: 'http://localhost:3975',
     validatorApiUrl: 'http://localhost:3903',
     authMode: 'shared-secret',
   };
   
   export const DEVNET_PRESET: Partial<EnvironmentConfig> = {
     environment: 'devnet',
     authMode: 'oauth2',
     // URLs configured by user
   };
   ```

### Phase 2: Configuration Validation

1. **Add configuration validator**:
   ```typescript
   export interface ValidationResult {
     valid: boolean;
     errors: string[];
     warnings: string[];
   }
   
   export function validateConfig(
     config: EnvironmentConfig
   ): ValidationResult;
   ```

2. **Validation rules by environment**:
   - LocalNet: Warn if using non-localhost URLs
   - OAuth2 mode: Require auth URL, client ID/secret
   - MainNet: Warn about production use

### Phase 3: Environment Detection

1. **Auto-detect environment from URL patterns**:
   ```typescript
   export function detectEnvironment(
     ledgerApiUrl: string
   ): Environment;
   ```

2. **Detect from environment variables**:
   ```typescript
   // Support standard env vars
   CANTON_ENVIRONMENT=devnet
   CANTON_LEDGER_API_URL=...
   CANTON_AUTH_MODE=oauth2
   ```

### Phase 4: OcpClient Factory Methods

1. **Add environment-specific factories**:
   ```typescript
   // Quick setup for LocalNet development
   const client = OcpClient.forLocalNet({
     party: 'app_provider',
   });
   
   // DevNet with OAuth2
   const client = OcpClient.forDevNet({
     authUrl: '...',
     clientId: '...',
     clientSecret: '...',
     party: '...',
   });
   
   // Full custom configuration
   const client = OcpClient.create({
     environment: 'custom',
     ...config,
   });
   ```

### Phase 5: Runtime Environment Helpers

1. **Add environment check utilities**:
   ```typescript
   if (client.isLocalNet()) {
     // Development-only code
   }
   
   if (client.isProduction()) {
     // Production safety checks
   }
   ```

2. **Environment-specific warnings**:
   ```typescript
   // Warn when using production-unsafe patterns in MainNet
   client.setProductionSafetyChecks(true);
   ```

### Phase 6: Documentation

1. **Environment setup guides**:
   - LocalNet quickstart
   - DevNet connection guide
   - OAuth2 configuration
   - Environment variables reference

2. **Migration guides**:
   - LocalNet → DevNet
   - DevNet → MainNet

## Testing Requirements

- [ ] Unit tests for configuration validation
- [ ] Unit tests for environment detection
- [ ] Integration tests for each environment preset
- [ ] Tests for environment variable loading

## Acceptance Criteria

- [ ] Environment presets available for LocalNet/DevNet
- [ ] Configuration validation catches common errors
- [ ] Factory methods simplify client creation
- [ ] Documentation covers environment setup
- [ ] Environment variables supported

## Related Documentation

- [CN Quickstart Development Lifecycle](https://docs.digitalasset.com/build/3.4/quickstart/configure/development-lifecycle.html)
- [CN Quickstart Project Structure](https://docs.digitalasset.com/build/3.4/quickstart/configure/project-structure-overview.html)
- [CN Quickstart FAQ](https://docs.digitalasset.com/build/3.4/quickstart/troubleshoot/cnqs-faq.html)

## Port Reference (LocalNet)

| Service | Port | Description |
|---------|------|-------------|
| App-Provider JSON API | 3975 | Ledger API for app_provider |
| App-Provider Validator | 3903 | Validator API for app_provider |
| App-User JSON API | 2975 | Ledger API for app_user |
| SV JSON API | 4975 | Ledger API for super validator |
| Keycloak | 8082 | OAuth2 authentication |

## Notes

- Environment presets should be optional - don't force specific patterns
- Validation should be helpful, not blocking
- Support both explicit configuration and environment variables
- Consider 12-factor app principles for configuration
