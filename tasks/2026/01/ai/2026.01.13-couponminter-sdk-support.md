# CouponMinter SDK Support

**Date**: 2026-01-13 **Status**: Open **Priority**: Low

## Overview

Add SDK support for the new `CouponMinter` contract, including helper functions for TPS rate limit
checking and full contract interaction capabilities.

## Background

The `CouponMinter` contract is a new DAML contract for minting Featured App Activity Markers (Splice
rewards) with optional on-chain TPS enforcement. It was designed in
[ADR-004](https://github.com/Fairmint/open-captable-protocol-daml/blob/main/docs/adr/004-couponminter-contract.md)
and deployed as described in the
[release notes](https://github.com/Fairmint/open-captable-protocol-daml/blob/main/docs/releases/2026.01.13-ocp-couponminter-initial-deployment.md).

### Contract Capabilities

1. **MintCoupons** - Mint activity markers with optional TPS rate limiting
2. **UpdateRateLimitConfig** - Configure TPS limits
3. **ArchiveCouponMinter** - Archive the contract

## Scope

### Part 1: TPS Rate Limit Helper (Low Priority)

Add client-side utility functions to check TPS rate limits before minting.

**Files to create:**

- `src/functions/CouponMinter/index.ts`
- `src/functions/CouponMinter/canMintCouponsNow.ts`
- `test/CouponMinter/canMintCouponsNow.test.ts`

**Implementation:**

```typescript
export interface CanMintResult {
  canMint: true;
} | {
  canMint: false;
  waitMs: number;
};

export interface CouponMinterPayload {
  operator: string;
  maxTps: string | null;
  lastMint: { time: string; count: number } | null;
}

export function canMintCouponsNow(
  payload: CouponMinterPayload,
  now?: Date
): CanMintResult;
```

**Rate limit formula:**

```
requiredWaitMicros = lastMint.count * 1_000_000 / maxTps
```

### Part 2: Full CouponMinter Operations (Future)

Add full SDK support for CouponMinter contract operations:

- [ ] `createCouponMinter` - Create new CouponMinter contract
- [ ] `mintCoupons` - Mint coupons with rate limit handling
- [ ] `updateRateLimitConfig` - Update TPS configuration
- [ ] `archiveCouponMinter` - Archive contract

This depends on the npm package `@fairmint/open-captable-protocol-daml-js` including the
CouponMinter contract types.

## Implementation Checklist

### Part 1: TPS Helper

- [ ] Define types for CouponMinter contract payload
  - [ ] `LastMint` interface with `time: string` and `count: number`
  - [ ] `CouponMinterPayload` interface
  - [ ] `CanMintResult` type

- [ ] Implement `canMintCouponsNow` function
  - [ ] Return `{ canMint: true }` if `maxTps` is null/undefined
  - [ ] Return `{ canMint: true }` if `lastMint` is null/undefined
  - [ ] Calculate `minIntervalMicros = lastMint.count * 1_000_000 / parsedMaxTps`
  - [ ] Calculate elapsed time since `lastMint.time`
  - [ ] Return appropriate result based on comparison

- [ ] Add exports and integrate with OcpClient
  - [ ] Export from `src/functions/index.ts`
  - [ ] Add to OcpClient under `CouponMinter` namespace

- [ ] Add unit tests
  - [ ] Test: no maxTps configured → always can mint
  - [ ] Test: no lastMint → always can mint
  - [ ] Test: enough time elapsed → can mint
  - [ ] Test: not enough time elapsed → returns waitMs
  - [ ] Test: edge cases (zero count, very high TPS, etc.)

### Part 2: Full Operations (Future)

- [ ] Wait for `@fairmint/open-captable-protocol-daml-js` to include CouponMinter types
- [ ] Implement create/mint/update/archive operations
- [ ] Add integration tests

## Example Usage

```typescript
import { canMintCouponsNow } from '@open-captable-protocol/canton';

// Query the CouponMinter contract from the ledger
const couponMinter = await ledgerClient.getContractById(couponMinterCid);

// Check if we can mint now
const result = canMintCouponsNow(couponMinter.payload);

if (result.canMint) {
  await mintCoupons(...);
} else {
  console.log(`Rate limited. Waiting ${result.waitMs}ms...`);
  await sleep(result.waitMs);
}
```

## Related

- DAML Contract: `open-captable-protocol-daml/CouponMinter/daml/Fairmint/CouponMinter.daml`
- ADR: `open-captable-protocol-daml/docs/adr/004-couponminter-contract.md`
- Original task spec: `project/tasks/2025.01.13_coupon_minter_can_mint_helper.task.md`

## Validation

```bash
npm run fix                    # Lint/format
npm run typecheck              # Type check
npm test                       # Unit tests
```

## Changelog

| Date       | Change       | PRs |
| ---------- | ------------ | --- |
| 2026-01-13 | Created task | —   |

---

_Last updated: 2026-01-13_
