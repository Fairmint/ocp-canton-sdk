# CouponMinter SDK Support

**Date**: 2026-01-13 **Status**: Partially Complete **Priority**: Low

## Overview

Add SDK support for the new `CouponMinter` contract, including helper functions for TPS rate limit
checking and full contract interaction capabilities.

## Background

The `CouponMinter` contract is a new DAML contract for minting Featured App Activity Markers (Splice
rewards) with optional on-chain TPS enforcement. It was designed in
[ADR-004](https://github.com/Fairmint/open-captable-protocol-daml/blob/main/docs/adr/004-couponminter-contract.md)
and deployed as described in the
[release notes](https://github.com/Fairmint/open-captable-protocol-daml/blob/main/docs/releases/2026.01.13-ocp-couponminter-initial-deployment.md).

### Contract Capabilities

1. **MintCoupons** - Mint activity markers with optional TPS rate limiting
2. **UpdateRateLimitConfig** - Configure TPS limits
3. **ArchiveCouponMinter** - Archive the contract

## Scope

### Part 1: TPS Rate Limit Helper (Low Priority)

Add client-side utility functions to check TPS rate limits before minting.

**Files to create:**

- `src/functions/CouponMinter/index.ts`
- `src/functions/CouponMinter/canMintCouponsNow.ts`
- `test/CouponMinter/canMintCouponsNow.test.ts`

**Implementation:**

```typescript
export type CanMintResult = { canMint: true } | { canMint: false; waitMs: number };

export interface CouponMinterPayload {
  operator: string;
  maxTps: string | null;
  lastMint: { time: string; count: number } | null;
}

export function canMintCouponsNow(payload: CouponMinterPayload, now?: Date): CanMintResult;
```

**Rate limit formula:**

```
requiredWaitMicros = lastMint.count * 1_000_000 / maxTps
```

### Part 1.5: Minting Wrapper Utilities (Complete)

Add fire-and-forget style minting with automatic rate limit handling.

**Files created:**

- `src/functions/CouponMinter/waitUntilCanMint.ts`
- `test/CouponMinter/waitUntilCanMint.test.ts`

**Implementation:**

```typescript
// Wait until minting is allowed, then proceed
await waitUntilCanMint(couponMinterPayload, {
  maxWaitMs: 60000, // Optional timeout
  signal: abortController.signal, // Optional abort support
  onWaitStart: (ms) => console.log(`Waiting ${ms}ms...`),
});

// Or use the fire-and-forget wrapper
const { result, wasRateLimited, waitedMs } = await mintWithRateLimit(
  couponMinterPayload,
  async () => ledgerClient.exerciseChoice(cid, 'MintCoupons', params),
  {
    onBeforeMint: () => console.log('Submitting mint...'),
    onWaitStart: (ms) => console.log(`Rate limited, waiting ${ms}ms...`),
  }
);
```

**Available utilities:**

- `waitUntilCanMint(payload, options?)` - Sleeps until minting is allowed
- `mintWithRateLimit(payload, mintFn, options?)` - Waits then executes mint function
- `getRateLimitStatus(payload, now?)` - Returns detailed rate limit status
- `WaitAbortedError` - Error thrown when wait is aborted via signal
- `WaitTimeoutError` - Error thrown when max wait time exceeded

### Part 2: Full CouponMinter Operations (Future)

Add full SDK support for CouponMinter contract operations:

- [ ] `createCouponMinter` - Create new CouponMinter contract
- [ ] `mintCoupons` - Mint coupons with rate limit handling
- [ ] `updateRateLimitConfig` - Update TPS configuration
- [ ] `archiveCouponMinter` - Archive contract

This depends on the npm package `@fairmint/open-captable-protocol-daml-js` including the
CouponMinter contract types.

## Implementation Checklist

### Part 1: TPS Helper (Complete)

- [x] Define types for CouponMinter contract payload
  - [x] `LastMint` interface with `time: string` and `count: number`
  - [x] `CouponMinterPayload` interface
  - [x] `CanMintResult` type

- [x] Implement `canMintCouponsNow` function
  - [x] Return `{ canMint: true }` if `maxTps` is null/undefined
  - [x] Return `{ canMint: true }` if `lastMint` is null/undefined
  - [x] Calculate `minIntervalMicros = lastMint.count * 1_000_000 / parsedMaxTps`
  - [x] Calculate elapsed time since `lastMint.time`
  - [x] Return appropriate result based on comparison

- [x] Add exports and integrate with OcpClient
  - [x] Export from `src/functions/index.ts`
  - [x] Add to OcpClient under `CouponMinter` namespace

- [x] Add unit tests
  - [x] Test: no maxTps configured → always can mint
  - [x] Test: no lastMint → always can mint
  - [x] Test: enough time elapsed → can mint
  - [x] Test: not enough time elapsed → returns waitMs
  - [x] Test: edge cases (zero count, very high TPS, etc.)

### Part 1.5: Minting Wrapper Utilities (Complete)

- [x] Implement `waitUntilCanMint` function
  - [x] Sleep until minting is allowed based on rate limits
  - [x] Support optional maxWaitMs timeout
  - [x] Support optional AbortSignal for cancellation
  - [x] Support onWaitStart callback for progress tracking

- [x] Implement `mintWithRateLimit` wrapper
  - [x] Fire-and-forget style: wait for rate limit, then execute mint
  - [x] Return whether rate limiting occurred and wait duration
  - [x] Support onBeforeMint callback
  - [x] Preserve generic return type from mint function

- [x] Add helper utilities
  - [x] `getRateLimitStatus` for detailed status with waitSeconds
  - [x] `WaitAbortedError` and `WaitTimeoutError` error classes

- [x] Add comprehensive unit tests
  - [x] Test immediate mint scenarios
  - [x] Test waiting scenarios
  - [x] Test timeout handling
  - [x] Test abort signal handling
  - [x] Test callback invocation order

### Part 2: Full Operations (Future)

- [ ] Wait for `@fairmint/open-captable-protocol-daml-js` to include CouponMinter types
- [ ] Implement create/mint/update/archive operations
- [ ] Add integration tests

## Example Usage

### Basic Rate Limit Check

```typescript
import { canMintCouponsNow } from '@open-captable-protocol/canton';

// Query the CouponMinter contract from the ledger
const couponMinter = await ledgerClient.getContractById(couponMinterCid);

// Check if we can mint now
const result = canMintCouponsNow(couponMinter.payload);

if (result.canMint) {
  await mintCoupons(...);
} else {
  console.log(`Rate limited. Waiting ${result.waitMs}ms...`);
  await sleep(result.waitMs);
}
```

### Fire-and-Forget Minting

```typescript
import { mintWithRateLimit } from '@open-captable-protocol/canton';

// Fire and forget - handles rate limiting automatically
const { result, wasRateLimited, waitedMs } = await mintWithRateLimit(
  couponMinter.payload,
  async () => {
    return await ledgerClient.exerciseChoice(couponMinterCid, 'MintCoupons', {
      count: 10,
      markers: [...],
    });
  },
  {
    maxWaitMs: 60000, // Optional: fail if rate limited > 60 seconds
    onWaitStart: (ms) => console.log(`Rate limited, waiting ${ms}ms...`),
    onBeforeMint: () => console.log('Submitting mint transaction...'),
  }
);

console.log(`Mint complete. Rate limited: ${wasRateLimited}, waited: ${waitedMs}ms`);
```

### Wait Then Mint Separately

```typescript
import { waitUntilCanMint, WaitTimeoutError, WaitAbortedError } from '@open-captable-protocol/canton';

const controller = new AbortController();

try {
  // Wait until we can mint
  await waitUntilCanMint(couponMinter.payload, {
    maxWaitMs: 30000,
    signal: controller.signal,
    onWaitStart: (ms) => updateUI(`Waiting ${ms}ms for rate limit...`),
  });

  // Now mint
  await mintCoupons(...);
} catch (error) {
  if (error instanceof WaitTimeoutError) {
    console.log('Timed out waiting for rate limit');
  } else if (error instanceof WaitAbortedError) {
    console.log('Wait was cancelled');
  } else {
    throw error;
  }
}
```

## Related

- DAML Contract: `open-captable-protocol-daml/CouponMinter/daml/Fairmint/CouponMinter.daml`
- ADR: `open-captable-protocol-daml/docs/adr/004-couponminter-contract.md`
- Original task spec: `project/tasks/2025.01.13_coupon_minter_can_mint_helper.task.md`

## Validation

```bash
npm run fix                    # Lint/format
npm run typecheck              # Type check
npm test                       # Unit tests
```

## Changelog

| Date       | Change                                                                | PRs |
| ---------- | --------------------------------------------------------------------- | --- |
| 2026-01-13 | Created task                                                          | —   |
| 2026-01-16 | Implemented Part 1: TPS rate limit helper with unit tests             | —   |
| 2026-01-20 | Added minting wrapper utilities (waitUntilCanMint, mintWithRateLimit) | —   |

---

_Last updated: 2026-01-20_
