# Task: Health Check Integration

## Status: Open

**Created**: 2026-01-16  
**Priority**: Low  
**Source**: [Canton Network TL;DR Documentation](https://docs.digitalasset.com/build/3.4/overview/tldr.html)

## Summary

Add utilities for checking Canton Network service health and readiness, enabling SDK consumers to 
implement proper health-aware service patterns.

## Background

The Canton Network provides health check endpoints for validator nodes:

```bash
# Validator health endpoints
curl -f http://localhost:2903/api/validator/readyz  # App User
curl -f http://localhost:3903/api/validator/readyz  # App Provider
```

The CN Quickstart documentation emphasizes:
- Waiting for services to become healthy before operations
- Using health checks for container orchestration
- Distinguishing between "ready" and "healthy" states

Currently, the SDK does not provide:
- Health check utilities
- Service readiness detection
- Graceful degradation patterns

## Implementation Steps

### Phase 1: Health Check Types

1. **Define health status types**:
   ```typescript
   export type HealthStatus = 'HEALTHY' | 'UNHEALTHY' | 'DEGRADED' | 'UNKNOWN';
   
   export interface ServiceHealth {
     status: HealthStatus;
     services: {
       ledgerApi: HealthStatus;
       validatorApi?: HealthStatus;
       pqs?: HealthStatus;
     };
     timestamp: Date;
     latencyMs?: number;
   }
   ```

### Phase 2: Health Check Utilities

1. **Add health check methods**:
   ```typescript
   export interface HealthCheckOptions {
     /** Timeout for health check in ms (default: 5000) */
     timeoutMs?: number;
     /** Include detailed service status (default: false) */
     detailed?: boolean;
   }
   
   export async function checkHealth(
     options?: HealthCheckOptions
   ): Promise<ServiceHealth>;
   ```

2. **Implement individual service checks**:
   ```typescript
   // Check JSON Ledger API health
   async function checkLedgerApiHealth(baseUrl: string): Promise<HealthStatus>;
   
   // Check Validator API health
   async function checkValidatorApiHealth(baseUrl: string): Promise<HealthStatus>;
   ```

### Phase 3: Wait-for-Ready Pattern

1. **Add wait-for-ready utility**:
   ```typescript
   export interface WaitForReadyOptions {
     /** Maximum wait time in ms (default: 300000 = 5 min) */
     maxWaitMs?: number;
     /** Interval between checks in ms (default: 5000) */
     checkIntervalMs?: number;
     /** Callback for progress updates */
     onProgress?: (attempt: number, health: ServiceHealth) => void;
   }
   
   export async function waitForReady(
     options?: WaitForReadyOptions
   ): Promise<ServiceHealth>;
   ```

2. **Use in OcpClient initialization**:
   ```typescript
   const client = await OcpClient.create({
     // ... config
     waitForReady: true, // Auto-wait for services on init
   });
   ```

### Phase 4: Connection State Management

1. **Track connection state**:
   ```typescript
   export interface ConnectionState {
     connected: boolean;
     lastHealthCheck?: Date;
     health?: ServiceHealth;
   }
   ```

2. **Add state change callbacks**:
   ```typescript
   client.onConnectionStateChange((state: ConnectionState) => {
     if (!state.connected) {
       // Handle disconnection
     }
   });
   ```

### Phase 5: Graceful Degradation

1. **Add circuit breaker state**:
   ```typescript
   export interface CircuitBreakerConfig {
     /** Number of failures before opening circuit */
     failureThreshold: number;
     /** Time to wait before trying again in ms */
     resetTimeoutMs: number;
   }
   ```

2. **Integrate with retry logic** from command tracking task

## Testing Requirements

- [ ] Unit tests for health check parsing
- [ ] Unit tests for wait-for-ready timeout handling
- [ ] Integration tests with LocalNet health endpoints
- [ ] Tests for degraded service handling

## Acceptance Criteria

- [ ] SDK can check service health status
- [ ] Wait-for-ready utility blocks until services are available
- [ ] Health check timeout is configurable
- [ ] Documentation explains health check usage patterns

## Related Documentation

- [CN Quickstart Project Structure - Health Checks](https://docs.digitalasset.com/build/3.4/quickstart/configure/project-structure-overview.html#health-checks)
- [CN Quickstart FAQ](https://docs.digitalasset.com/build/3.4/quickstart/troubleshoot/cnqs-faq.html)

## Notes

- Health checks should be non-blocking by default
- Consider caching health status with TTL
- LocalNet can take 4-5 minutes to become healthy - document this
