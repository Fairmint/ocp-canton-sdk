# Property-Based Testing for Type Conversions

**Date**: 2026-01-16 **Status**: Open **Priority**: Low **Parent**:
[Library Refactoring and Testing](./2026.01.02-library-refactoring-and-testing.md)

## Overview

Add property-based tests to verify type conversion invariants and catch edge cases that traditional
unit tests might miss.

## Current State

The SDK has good unit test coverage for type conversions in `test/utils/typeConversions.test.ts`,
but these tests use specific example values. Property-based testing would generate many random
inputs to verify that conversion functions maintain their invariants.

### Current Test Pattern

```typescript
// test/utils/typeConversions.test.ts
test('normalizeNumericString removes trailing zeros', () => {
  expect(normalizeNumericString('5000000.0000000000')).toBe('5000000');
  expect(normalizeNumericString('1.50')).toBe('1.5');
});
```

### Gap

These tests verify specific cases but don't systematically explore edge cases like:

- Very large numbers
- Very small decimals
- Negative numbers
- Numbers at precision boundaries
- Unicode edge cases in strings
- Date boundary conditions

## Goals

### 1. Round-Trip Property Tests

Verify that converting to DAML and back produces the same value:

```typescript
import fc from 'fast-check';

describe('DAML â†” Native Round-Trip', () => {
  test('monetary round-trip preserves value', () => {
    fc.assert(
      fc.property(
        fc.record({
          amount: fc.oneof(
            fc.integer().map(String),
            fc.float({ min: 0, max: 1e15 }).map((n) => n.toFixed(10))
          ),
          currency: fc.stringOf(fc.constantFrom(...'ABCDEFGHIJKLMNOPQRSTUVWXYZ'), {
            minLength: 3,
            maxLength: 3,
          }),
        }),
        (monetary) => {
          const daml = monetaryToDaml(monetary);
          const native = damlMonetaryToNative(daml);
          // Normalized amounts should be equal
          expect(normalizeNumericString(native.amount)).toBe(
            normalizeNumericString(monetary.amount)
          );
          expect(native.currency).toBe(monetary.currency);
        }
      )
    );
  });
});
```

### 2. Numeric String Normalization Properties

```typescript
describe('normalizeNumericString properties', () => {
  test('idempotent: normalizing twice equals normalizing once', () => {
    fc.assert(
      fc.property(
        fc.float({ min: -1e15, max: 1e15 }).map((n) => n.toString()),
        (numStr) => {
          if (numStr.includes('e')) return true; // Skip scientific notation
          try {
            const once = normalizeNumericString(numStr);
            const twice = normalizeNumericString(once);
            expect(twice).toBe(once);
            return true;
          } catch {
            return true; // Invalid inputs expected to throw
          }
        }
      )
    );
  });

  test('preserves numeric value', () => {
    fc.assert(
      fc.property(
        fc.integer({ min: -1e10, max: 1e10 }),
        fc.integer({ min: 0, max: 10 }),
        (integer, decimals) => {
          const value = integer + decimals / Math.pow(10, 10);
          const str = value.toFixed(10);
          const normalized = normalizeNumericString(str);
          // Parsed values should be equal within floating point precision
          expect(Math.abs(parseFloat(normalized) - value)).toBeLessThan(1e-10);
        }
      )
    );
  });
});
```

### 3. Date Conversion Properties

```typescript
describe('date conversion properties', () => {
  test('date round-trip preserves date portion', () => {
    fc.assert(
      fc.property(
        fc.date({
          min: new Date('1900-01-01'),
          max: new Date('2100-12-31'),
        }),
        (date) => {
          const dateStr = date.toISOString().split('T')[0];
          const damlTime = dateStringToDAMLTime(dateStr);
          const backToDate = damlTimeToDateString(damlTime);
          expect(backToDate).toBe(dateStr);
        }
      )
    );
  });
});
```

### 4. Address Conversion Properties

```typescript
describe('address conversion properties', () => {
  test('address round-trip preserves all fields', () => {
    fc.assert(
      fc.property(
        fc.record({
          address_type: fc.constantFrom('LEGAL', 'CONTACT', 'OTHER'),
          country: fc.stringOf(fc.constantFrom(...'ABCDEFGHIJKLMNOPQRSTUVWXYZ'), {
            minLength: 2,
            maxLength: 2,
          }),
          street_suite: fc.option(fc.string({ minLength: 1, maxLength: 100 })),
          city: fc.option(fc.string({ minLength: 1, maxLength: 50 })),
          country_subdivision: fc.option(fc.string({ minLength: 1, maxLength: 50 })),
          postal_code: fc.option(fc.string({ minLength: 1, maxLength: 20 })),
        }),
        (address) => {
          const daml = addressToDaml(address as Address);
          const native = damlAddressToNative(daml);
          expect(native.address_type).toBe(address.address_type);
          expect(native.country).toBe(address.country);
        }
      )
    );
  });
});
```

## Implementation Plan

### Phase 1: Setup

- [ ] Add `fast-check` as dev dependency: `npm install --save-exact --save-dev fast-check`
- [ ] Create `test/property/` directory for property tests
- [ ] Add Jest configuration for property tests

### Phase 2: Core Conversion Tests

- [ ] Create `test/property/typeConversions.property.test.ts`
- [ ] Add monetary round-trip tests
- [ ] Add date round-trip tests
- [ ] Add numeric string normalization tests

### Phase 3: Entity Conversion Tests

- [ ] Add address round-trip tests
- [ ] Add stakeholder data round-trip tests
- [ ] Add stock class data round-trip tests

### Phase 4: Integration with CI

- [ ] Add property tests to test suite
- [ ] Configure appropriate iteration counts (lower for CI, higher for local)
- [ ] Document how to run extended property tests locally

## Files to Create

- `test/property/typeConversions.property.test.ts`
- `test/property/entityConversions.property.test.ts`

## Files to Modify

- `package.json` - Add fast-check dependency
- `jest.config.js` - Include property test directory

## Dependencies

```json
{
  "devDependencies": {
    "fast-check": "3.15.0"
  }
}
```

## Validation

```bash
npm run fix                    # Lint/format
npm run typecheck              # Type check
npm test                       # All tests including property tests
npm test -- --testPathPattern=property  # Property tests only
```

## Related

- [Library Refactoring and Testing](./2026.01.02-library-refactoring-and-testing.md)
- `test/utils/typeConversions.test.ts` - Existing unit tests

## Changelog

| Date       | Change       | PRs |
| ---------- | ------------ | --- |
| 2026-01-16 | Created task | --  |

---

_Last updated: 2026-01-16_
