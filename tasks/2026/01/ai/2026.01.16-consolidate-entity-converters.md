# Consolidate Entity Converters

**Date**: 2026-01-16 **Status**: Open **Priority**: Medium **Parent**:
[Library Refactoring and Testing](./2026.01.02-library-refactoring-and-testing.md)

## Overview

Extract and centralize duplicated entity conversion code into reusable utilities to reduce code
duplication and improve maintainability.

## Current State

Each entity type has similar conversion patterns duplicated across files:

```
src/functions/OpenCapTable/
├── stakeholder/stakeholderDataToDaml.ts
├── stockClass/stockClassDataToDaml.ts
├── stockIssuance/createStockIssuance.ts (contains stockIssuanceDataToDaml)
├── stockRepurchase/stockRepurchaseDataToDaml.ts
├── capTable/ocfToDaml.ts (centralized for batch API)
└── ...
```

### Common Patterns

1. **Enum conversions** - `stakeholderTypeToDaml()`, `stockClassTypeToDaml()`, etc.
2. **Monetary conversions** - `monetaryToDaml()` used everywhere
3. **Date conversions** - `dateStringToDAMLTime()` used everywhere
4. **Optional field handling** - `optionalString()`, `cleanComments()` patterns
5. **Required field validation** - Similar validation at start of each converter

### Issues

- **Duplication**: Similar code in 20+ entity converter files
- **Inconsistency**: Some converters are in dedicated files, others inline in create functions
- **Maintenance burden**: Changes must be made in multiple places

## Goals

### 1. Centralize Enum Converters

Create a single `src/utils/enumConversions.ts` for all enum mappings:

```typescript
// src/utils/enumConversions.ts
export const stakeholderTypeToDaml = (type: StakeholderType): DamlStakeholderType => { ... };
export const damlStakeholderTypeToNative = (type: DamlStakeholderType): StakeholderType => { ... };
export const stockClassTypeToDaml = (type: StockClassType): DamlStockClassType => { ... };
// ... all other enum conversions
```

### 2. Consolidate Entity Converters

The batch API's `ocfToDaml.ts` already provides a centralized dispatcher. Migrate standalone
converters to use this pattern:

```typescript
// Already exists in src/functions/OpenCapTable/capTable/ocfToDaml.ts
export function convertToDaml(type: OcfEntityType, data: OcfDataTypeFor<OcfEntityType>): unknown {
  switch (type) {
    case 'stakeholder':
      return stakeholderDataToDaml(data as OcfStakeholder);
    // ... other types
  }
}
```

### 3. Extract Shared Validation Utilities

Create `src/utils/validation.ts` for common validation patterns:

```typescript
export function validateRequired<T>(value: T | undefined | null, fieldPath: string): T {
  if (value === null || value === undefined || value === '') {
    throw new Error(`${fieldPath} is required`);
  }
  return value;
}

export function validateEntityData<T extends { id: string }>(data: T, entityType: string): void {
  validateRequired(data.id, `${entityType}.id`);
}
```

## Implementation Plan

### Phase 1: Enum Consolidation

- [ ] Create `src/utils/enumConversions.ts`
- [ ] Move all enum converters from entity files
- [ ] Update entity files to import from centralized location
- [ ] Add comprehensive tests

### Phase 2: Validation Utilities

- [ ] Create `src/utils/validation.ts`
- [ ] Extract common validation patterns
- [ ] Update entity converters to use shared validation
- [ ] Ensure error messages remain clear and specific

### Phase 3: Cleanup Legacy Converters

- [ ] Identify converters that can be removed after batch API migration
- [ ] Mark legacy converters with deprecation notices
- [ ] Update imports across codebase

## Files to Create

- `src/utils/enumConversions.ts` - Centralized enum conversion functions
- `src/utils/validation.ts` - Shared validation utilities

## Files to Modify

- All `*DataToDaml.ts` files in `src/functions/OpenCapTable/`
- `src/utils/typeConversions.ts` - May absorb some functions
- `src/utils/index.ts` - Export new utilities

## Validation

```bash
npm run fix                    # Lint/format
npm run typecheck              # Type check
npm test                       # Unit tests
npm run test:integration       # Integration tests
```

## Related

- [Library Refactoring and Testing](./2026.01.02-library-refactoring-and-testing.md)
- [Batch Cap Table Updates](./2026.01.12-batch-cap-table-updates.md)

## Changelog

| Date       | Change       | PRs |
| ---------- | ------------ | --- |
| 2026-01-16 | Created task | --  |

---

_Last updated: 2026-01-16_
