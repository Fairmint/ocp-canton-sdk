# OcpClient API Simplification

**Date**: 2026-01-16 **Status**: Open **Priority**: Medium **Parent**:
[Library Refactoring and Testing](./2026.01.02-library-refactoring-and-testing.md)

## Overview

Simplify the `OcpClient` class to improve maintainability, reduce boilerplate, and provide a more
ergonomic developer experience.

## Current State

The `OcpClient.ts` file is ~600 lines with several patterns that could be improved:

1. **Inline `require()` statements** - Lazy loading via `require()` is used for `CantonPayments` and
   `PaymentStreams` to avoid circular dependencies, but creates eslint warnings and reduces type
   safety
2. **Repetitive method wiring** - Each entity's methods are manually wired with similar boilerplate
3. **No context caching** - `featuredAppRightContractDetails` must be passed to every call
4. **Mixed patterns** - Some methods use async wrappers, others return build functions directly

## Goals

### 1. Context Caching for Common Parameters

Store `featuredAppRightContractDetails` and `actAs` parties after first successful operation:

```typescript
// Current: Must pass every time
const issuer = await ocp.OpenCapTable.issuer.getIssuerAsOcf({
  contractId,
  actAs: [party],
  featuredAppRightContractDetails, // Repetitive
});

// Proposed: Context cached after authorization
await ocp.setContext({ featuredAppRightContractDetails, defaultActAs: [party] });
const issuer = await ocp.OpenCapTable.issuer.getIssuerAsOcf({ contractId });
```

### 2. Replace `require()` with Dynamic Imports

Convert lazy `require()` calls to ES module dynamic imports:

```typescript
// Current (problematic)
buildCreateAirdropCommand: (params) => {
  const { buildCreateAirdropCommand } = require('./functions/CantonPayments/airdrop');
  return buildCreateAirdropCommand(params);
},

// Proposed (cleaner)
buildCreateAirdropCommand: async (params) => {
  const { buildCreateAirdropCommand } = await import('./functions/CantonPayments/airdrop');
  return buildCreateAirdropCommand(params);
},
```

Or better, use a plugin/extension pattern:

```typescript
// Extensions are loaded separately
import { CantonPaymentsExtension } from './extensions/CantonPayments';
ocp.extend(CantonPaymentsExtension);
```

### 3. Reduce Method Wiring Boilerplate

Use a factory pattern to generate entity method objects:

```typescript
// Current: Manual wiring for each entity
stockClass: {
  getStockClassAsOcf: async (params) => getStockClassAsOcf(this.client, params),
},
stakeholder: {
  getStakeholderAsOcf: async (params) => getStakeholderAsOcf(this.client, params),
},

// Proposed: Factory-generated
private createEntityMethods<T extends EntityType>(type: T): EntityMethods<T> {
  return {
    getAsOcf: (params) => this.getEntityAsOcf(type, params),
    // ... other standard methods
  };
}
```

### 4. Consistent Async/Sync Pattern

Standardize on a consistent pattern for all methods:

- **Command builders**: Synchronous, return `CommandWithDisclosedContracts`
- **Execution methods**: Async, return result promises
- **Query methods**: Async, return data promises

## Implementation Plan

### Phase 1: Context Caching âœ… Complete (via Library Refactoring task)

- [x] Add `OcpClientContext` interface (implemented as `OcpContextManager` in 2026-01-20)
- [x] Add `setContext()` and `getContext()` methods (via `set*()` and `require*()` methods)
- [x] Update methods to use cached context as fallback
- [ ] Add tests for context caching

### Phase 2: Module Loading Cleanup

- [ ] Replace `require()` with dynamic imports or refactor to avoid circular deps
- [ ] Remove eslint disable comments
- [ ] Verify all methods still work correctly

### Phase 3: Factory Pattern (Optional)

- [ ] Create entity method factory
- [ ] Migrate existing entities to use factory
- [ ] Ensure TypeScript types remain accurate

## Files to Modify

- `src/OcpClient.ts` - Main refactoring target
- `src/types/index.ts` - Add context type exports

## Validation

```bash
npm run fix                    # Lint/format
npm run typecheck              # Type check
npm test                       # Unit tests
npm run test:integration       # Integration tests
```

## Related

- [Library Refactoring and Testing](./2026.01.02-library-refactoring-and-testing.md)
- [Batch Cap Table Updates](./2026.01.12-batch-cap-table-updates.md)

## Changelog

| Date       | Change       | PRs |
| ---------- | ------------ | --- |
| 2026-01-16 | Created task | --  |

---

_Last updated: 2026-01-16_
