# Milestone 2: OCP SDK Implementation & Testing

**Date**: 2025-12-17 **Status**: In Progress **Target Repo**: `ocp-canton-sdk`

## Goal

1. Add SDK support for all OCF object types implemented in Milestone 1
2. Establish robust testing strategy (mocks + LocalNet)
3. Validate SDK implementation using LocalNet with real mainnet data

## References

- [Milestone 1: DAML Implementation](https://github.com/Fairmint/open-captable-protocol-daml/blob/main/tasks/2025/12/2025.12.17-milestone-1-complete-daml-implementation.md)
- [OCF Implementation Status](https://github.com/fairmint/open-captable-protocol-daml/blob/main/docs/OCF_IMPLEMENTATION_STATUS.md)
- [ADR-001: OCF Cap Table](https://github.com/Fairmint/canton/blob/main/docs/developer/adr/001-ocf-captable-on-canton.md)

---

## Sub-Tasks

This milestone is broken down into the following sub-tasks:

### Infrastructure

| Task                                                                                      | Status      | Description                               |
| ----------------------------------------------------------------------------------------- | ----------- | ----------------------------------------- |
| [Batch Cap Table Updates](../../2026/01/ai/2026.01.12-batch-cap-table-updates.md)         | In Progress | Batch API infrastructure (Phase 1-3 done) |
| [Legacy Function Deprecation](../../2026/01/ai/2026.01.16-legacy-function-deprecation.md) | Open        | Deprecate per-entity functions            |

### OCF Type Implementation (27 remaining types)

| Task                                                                                        | Status | Priority | Types   |
| ------------------------------------------------------------------------------------------- | ------ | -------- | ------- |
| [Exercise & Conversion Types](../../2026/01/ai/2026.01.20-ocf-exercise-conversion-types.md) | Open   | High     | 3 types |
| [Valuation & Vesting Types](../../2026/01/ai/2026.01.20-ocf-valuation-vesting-types.md)     | Open   | High     | 4 types |
| [Security Transfer Types](../../2026/01/ai/2026.01.20-ocf-transfer-types.md)                | Open   | Medium   | 3 types |
| [Acceptance Types](../../2026/01/ai/2026.01.20-ocf-acceptance-types.md)                     | Open   | Medium   | 4 types |
| [Stock Class Adjustments](../../2026/01/ai/2026.01.20-ocf-stock-class-adjustments.md)       | Open   | Medium   | 4 types |
| [Remaining Types](../../2026/01/ai/2026.01.20-ocf-remaining-types.md)                       | Open   | Low      | 9 types |

### Testing & Validation

Testing infrastructure is largely complete. Remaining work:

- [ ] Add LocalNet tests to CI (PRs + nightly)
- [ ] Implement verification logic (compare Canton state vs DB state)

---

## Part 1: Testing Strategy

See
[ADR-002: Cap Table Replication & Verification](https://github.com/Fairmint/canton/blob/main/docs/developer/adr/002-state-verification.md)
for the detailed verification architecture.

### Current State ✅

The SDK uses:

- **Mock-based unit tests** (`test/mocks/`) - Fast, isolated ✅
- **JSON fixtures** (`test/fixtures/createOcf/`) - 30+ OCF samples ✅
- **OCF schema validation** - Validates against official schemas ✅
- **LocalNet integration tests** - Full round-trip testing ✅

### Approach

We use a **Hybrid Approach**:

1.  **Mocks**: For type conversions, command building, and schema validation.
1.  **LocalNet**: For full round-trip testing and verification against mainnet data (see ADR-002).

### Remaining Implementation

- [x] Add LocalNet setup scripts (leverage canton-node-sdk) ✅
- [x] Create `jest.integration.config.js` ✅
- [x] Add npm scripts: `test:integration` ✅
- [x] Create test utilities (party setup, cleanup) ✅
- [ ] Add LocalNet tests to CI (PRs + nightly)
- [ ] Implement verification logic (compare Canton state vs DB state)

---

## Part 2: OCF Object Types

**Status**: 21 of 48 types implemented (see sub-tasks above for remaining 27 types)

The SDK now uses a batch API pattern via `ocp.OpenCapTable.capTable.update()`. New types are
implemented by adding converters to `ocfToDaml.ts` and corresponding DAML → OCF converters.

### Implementation Pattern (Batch API)

```typescript
// Create entities via batch API
const result = await ocp.OpenCapTable.capTable
  .update({ capTableContractId })
  .create('stakeholder', stakeholderData)
  .create('stockIssuance', issuanceData)
  .execute();
```

See [ADR-001: Batch Cap Table Updates](../../adr/001-batch-cap-table-updates.md) for details.

---

## Part 3: SDK Validation via Cap Table Comparison

Use LocalNet testing to validate the SDK implementation by comparing cap tables.

### Scope

- [ ] Deploy test company data to LocalNet
- [ ] Read back all OCF objects from LocalNet
- [ ] Generate cap table from LocalNet Canton data
- [ ] Compare against cap table from database
- [ ] Validate complete parity

### Implementation

- [ ] LocalNet deployment script for test company
- [ ] Canton data reader (for LocalNet)
- [ ] Cap table comparison logic
- [ ] Test assertions for parity validation
- [ ] Clear diff output on mismatch

### Connection to Milestone 3

The comparison logic developed here becomes the foundation for:

- Production replication services
  ([Milestone 3a: Cap Table Replication](https://github.com/Fairmint/canton/blob/main/tasks/2025/12/2025.12.17-milestone-3a-cap-table-replication.md))
- Ongoing drift monitoring
  ([Milestone 3b: Drift Monitoring & Alerting](https://github.com/Fairmint/canton/blob/main/tasks/2025/12/2025.12.17-milestone-3b-drift-monitoring.md))

---

## Validation Commands

```bash
cd ocp-canton-sdk

# Unit tests (mocks)
npm test

# Integration tests (requires LocalNet)
npm run test:integration

# Full validation
npm run fix && npm run typecheck && npm test
```

## Success Criteria

### Testing

- [x] LocalNet integration test framework ✅
- [x] Full cap table workflow passes end-to-end ✅
- [ ] LocalNet integration tests in CI
- [ ] Test company cap table matches database (LocalNet validation)

### SDK Coverage

- [x] Batch API infrastructure complete ✅
- [x] 21 OCF types implemented ✅
- [ ] All 48 OCF types have SDK support (27 remaining - see sub-tasks)
- [ ] Each type has unit test + integration test
- [x] OCF schema validation passes ✅

## Dependencies

- Milestone 1 complete (DAML types must exist first) ✅

## Notes

- **Hybrid testing**: Mocks for speed, LocalNet for confidence
- **Batch API**: All new types should be implemented via the batch API pattern
- **Sub-tasks**: See the sub-tasks section above for detailed implementation tracking

---

## Changelog

| Date       | Change                                                                                                                                 | PRs                                                                                                                                  |
| ---------- | -------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| 2026-01-20 | Restructured task: added sub-task tracking, split OCF types into 6 focused tasks                                                       | —                                                                                                                                    |
| 2026-01-16 | Completed batch API phases 1-3, comprehensive integration tests                                                                        | —                                                                                                                                    |
| 2025-01-02 | Moved task file from canton to ocp-canton-sdk                                                                                          | —                                                                                                                                    |
| 2025-12-29 | Created modular integration test framework with per-entity files, shared harness, and complete stockClass example                      | [ocp-canton-sdk#101](https://github.com/Fairmint/ocp-canton-sdk/pull/101), [canton#140](https://github.com/Fairmint/canton/pull/140) |
| 2025-12-29 | SDK improvements: ESLint fix, dead code removal, integration test infrastructure, comprehensive integration tests, JSDoc documentation | [ocp-canton-sdk#100](https://github.com/Fairmint/ocp-canton-sdk/pull/100), [canton#139](https://github.com/Fairmint/canton/pull/139) |
| 2025-12-29 | Implemented TX_STOCK_TRANSFER SDK support (first type for Milestone 2)                                                                 | [ocp-canton-sdk#99](https://github.com/Fairmint/ocp-canton-sdk/pull/99), [canton#138](https://github.com/Fairmint/canton/pull/138)   |

---

_Last updated: 2026-01-20_
