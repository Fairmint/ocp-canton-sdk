# Task: OCP SDK Implementation & Testing

**Date**: 2025-12-17 **Status**: In Progress **Target Repo**: `ocp-canton-sdk`

## Goal

1. Add SDK support for all OCF object types implemented in Milestone 1
2. Establish robust testing strategy (mocks + LocalNet)
3. Validate SDK implementation using LocalNet with real mainnet data

## References

- [Milestone 1: DAML Implementation](https://github.com/Fairmint/open-captable-protocol-daml/blob/main/tasks/2025/12/2025.12.17-milestone-1-complete-daml-implementation.md)
- [OCF Implementation Status](https://github.com/fairmint/open-captable-protocol-daml/blob/main/docs/OCF_IMPLEMENTATION_STATUS.md)
- [ADR-001: OCF Cap Table](https://github.com/Fairmint/canton/blob/main/docs/developer/adr/001-ocf-captable-on-canton.md)

---

## Part 1: Testing Strategy

See
[ADR-002: Cap Table Replication & Verification](https://github.com/Fairmint/canton/blob/main/docs/developer/adr/002-state-verification.md)
for the detailed verification architecture.

### Current State

The SDK uses:

- **Mock-based unit tests** (`test/mocks/`) - Fast, isolated
- **JSON fixtures** (`test/fixtures/createOcf/`) - 30+ OCF samples
- **OCF schema validation** - Validates against official schemas

### Approach

We use a **Hybrid Approach**:

1.  **Mocks**: For type conversions, command building, and schema validation.
1.  **LocalNet**: For full round-trip testing and verification against mainnet data (see ADR-002).

### Implementation

- [ ] Add LocalNet setup scripts (leverage canton-node-sdk)
- [ ] Create `jest.localnet.config.js`
- [ ] Add npm scripts: `test:localnet`, `localnet:start`, `localnet:stop`
- [ ] Create test utilities (party setup, cleanup)
- [ ] Add LocalNet tests to CI (PRs + nightly)
- [ ] Implement verification logic (compare Canton state vs DB state)

---

## Part 2: New OCF Object Types

For each DAML type from Milestone 1, add SDK support.

### Pattern per Type

```
src/functions/OpenCapTable/{entity}/
├── create{Entity}.ts           # Create function
├── get{Entity}AsOcf.ts         # Read (DAML → OCF)
├── archive{Entity}ByIssuer.ts  # Archive
└── index.ts                    # Barrel export
```

### High Priority

- [x] TX_STOCK_TRANSFER ✅
- [ ] TX_CONVERTIBLE_CONVERSION
- [ ] TX_WARRANT_EXERCISE
- [ ] TX_STOCK_REPURCHASE
- [ ] Financing

### Medium Priority

- [ ] Cancellations (3 types)
- [ ] Transfers (3 types)
- [ ] Adjustments (3 types)
- [ ] TX_EQUITY_COMPENSATION_RELEASE
- [ ] TX_STOCK_CONVERSION

### Lower Priority

- [ ] Vesting (3 types)
- [ ] Acceptance (4 types)
- [ ] Retraction (4 types)
- [ ] Other (3 types)
- [ ] Change events (2 types)

---

## Part 3: SDK Validation via Cap Table Comparison

Use LocalNet testing to validate the SDK implementation by comparing cap tables.

### Scope

- [ ] Deploy test company data to LocalNet
- [ ] Read back all OCF objects from LocalNet
- [ ] Generate cap table from LocalNet Canton data
- [ ] Compare against cap table from database
- [ ] Validate complete parity

### Implementation

- [ ] LocalNet deployment script for test company
- [ ] Canton data reader (for LocalNet)
- [ ] Cap table comparison logic
- [ ] Test assertions for parity validation
- [ ] Clear diff output on mismatch

### Connection to Milestone 3

The comparison logic developed here becomes the foundation for:

- Production replication services
  ([Milestone 3a: Cap Table Replication](https://github.com/Fairmint/canton/blob/main/tasks/2025/12/2025.12.17-milestone-3a-cap-table-replication.md))
- Ongoing drift monitoring
  ([Milestone 3b: Drift Monitoring & Alerting](https://github.com/Fairmint/canton/blob/main/tasks/2025/12/2025.12.17-milestone-3b-drift-monitoring.md))

---

## Validation Commands

```bash
cd ocp-canton-sdk

# Unit tests (mocks)
npm test

# Integration tests (requires LocalNet)
npm run localnet:start
npm run test:localnet
npm run localnet:stop

# Full validation
npm run lint && npx tsc --noEmit && npm test
```

## Success Criteria

### Testing

- [ ] LocalNet integration tests in CI
- [ ] Full cap table workflow passes end-to-end
- [ ] Test company cap table matches database (LocalNet validation)

### SDK Coverage

- [ ] All high-priority OCF types have SDK support
- [ ] Each type has unit test + integration test
- [ ] OCF schema validation passes

## Dependencies

- Milestone 1 complete (DAML types must exist first)

## Notes

- **Hybrid testing**: Mocks for speed, LocalNet for confidence
- **Coordination**: Run integration tests as DAML types are implemented
- **CI**: Integration tests on PR + nightly (not every commit)

---

## Changelog

| Date       | Change                                                                                                                                 | PRs                                                                                                                                  |
| ---------- | -------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| 2025-01-02 | Moved task file from canton to ocp-canton-sdk                                                                                          | —                                                                                                                                    |
| 2025-12-29 | Created modular integration test framework with per-entity files, shared harness, and complete stockClass example                      | [ocp-canton-sdk#101](https://github.com/Fairmint/ocp-canton-sdk/pull/101), [canton#140](https://github.com/Fairmint/canton/pull/140) |
| 2025-12-29 | SDK improvements: ESLint fix, dead code removal, integration test infrastructure, comprehensive integration tests, JSDoc documentation | [ocp-canton-sdk#100](https://github.com/Fairmint/ocp-canton-sdk/pull/100), [canton#139](https://github.com/Fairmint/canton/pull/139) |
| 2025-12-29 | Implemented TX_STOCK_TRANSFER SDK support (first type for Milestone 2)                                                                 | [ocp-canton-sdk#99](https://github.com/Fairmint/ocp-canton-sdk/pull/99), [canton#138](https://github.com/Fairmint/canton/pull/138)   |

---

_Last updated: 2025-01-02_
