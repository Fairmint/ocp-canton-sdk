# Comprehensive SDK Integration Tests

**Date:** 2025-12-30 **Status:** Complete

---

## Summary

Expand integration test coverage to include all SDK functions with a proper test framework that:

1. Deploys DAML contracts to LocalNet (no placeholders)
2. Creates the OcpFactory contract dynamically
3. Runs through as much of the real workflow as possible

---

## Problem

The integration test framework was established with 4 entity types as examples:

- `issuer`
- `stakeholder`
- `stockClass`
- `stockClassAuthorizedSharesAdjustment`

However, the SDK exposes **17 OpenCapTable entity types** plus **3 additional domains** (Reports,
Payments, Streams). Without comprehensive integration tests, we cannot verify:

- DAML command structures are correct
- Type conversions work at runtime
- Contract workflows function end-to-end
- OCF schema compliance for all entity types

Additionally:

- Tests relied on pre-generated factory contract IDs for devnet/mainnet
- LocalNet testing required manual setup and couldn't create factories dynamically

---

## Solution - Integration Test Framework

### Contract Deployment System

Created `test/integration/setup/contractDeployment.ts` with:

```typescript
// Deploy DAML contracts and create OcpFactory
export async function deployAndCreateFactory(
  client: LedgerJsonApiClient,
  systemOperatorParty: string,
  featuredAppRightContractId: string
): Promise<DeploymentResult>;

// Authorize issuers using the dynamically created factory
export async function authorizeIssuerWithFactory(
  client: LedgerJsonApiClient,
  ocpFactoryContractId: string,
  systemOperatorParty: string,
  issuerParty: string
): Promise<AuthorizeIssuerResult>;
```

### Enhanced Test Context

The `IntegrationTestContext` now includes:

- `ocp`: OcpClient instance
- `issuerParty`: Party for issuer operations
- `systemOperatorParty`: Party owning the OcpFactory
- `featuredAppRight`: DisclosedContract for FeaturedAppRight
- `ocpFactoryContractId`: Dynamically created factory contract
- `deployment`: Full deployment info (package IDs, etc.)

### Test Setup Flow

```
1. Start cn-quickstart LocalNet
2. Integration harness initializes:
   a. Connects to Ledger JSON API
   b. Gets FeaturedAppRight from Validator API
   c. Uploads OCP DAML DAR (if not already deployed)
   d. Creates OcpFactory contract (if not exists)
   e. Discovers parties (issuer, system operator)
3. Tests use factory to authorize issuers and run workflows
```

---

## Test Structure

```
test/integration/
├── entities/                    # OpenCapTable entity tests (all implemented)
│   ├── issuer.integration.test.ts                              ✅
│   ├── stakeholder.integration.test.ts                         ✅
│   ├── stockClass.integration.test.ts                          ✅
│   ├── stockClassAuthorizedSharesAdjustment.integration.test.ts ✅
│   ├── stockLegendTemplate.integration.test.ts                 ✅
│   ├── vestingTerms.integration.test.ts                        ✅
│   ├── stockPlan.integration.test.ts                           ✅
│   ├── stockIssuance.integration.test.ts                       ✅
│   ├── stockTransfer.integration.test.ts                       ✅
│   ├── stockCancellation.integration.test.ts                   ✅
│   ├── stockRepurchase.integration.test.ts                     ✅
│   ├── equityCompensationIssuance.integration.test.ts          ✅
│   ├── warrantIssuance.integration.test.ts                     ✅
│   ├── convertibleIssuance.integration.test.ts                 ✅
│   ├── document.integration.test.ts                            ✅
│   ├── issuerAuthorization.integration.test.ts                 ✅
│   └── issuerAuthorizedSharesAdjustment.integration.test.ts    ✅
├── reports/                     # OpenCapTableReports tests
│   └── companyValuationReport.integration.test.ts              ✅ (simplified)
├── payments/                    # CantonPayments tests
│   ├── airdrop.integration.test.ts                             ✅ (simplified)
│   └── simpleAirdrop.integration.test.ts                       ✅ (simplified)
├── streams/                     # PaymentStreams tests
│   ├── paymentStreamFactory.integration.test.ts                ✅ (simplified)
│   ├── proposedPaymentStream.integration.test.ts               ✅ (simplified)
│   ├── activePaymentStream.integration.test.ts                 ✅ (simplified)
│   ├── paymentStreamChangeProposal.integration.test.ts         ✅ (simplified)
│   └── partyMigrationProposal.integration.test.ts              ✅ (simplified)
├── workflows/                   # Multi-entity workflow tests
│   └── capTableWorkflow.integration.test.ts                    ✅
├── setup/                       # Test infrastructure
│   ├── index.ts
│   ├── integrationTestHarness.ts                               ✅
│   ├── entityTestFactory.ts
│   └── contractDeployment.ts                                   ✅
└── utils/                       # Test data factories
    ├── index.ts
    ├── setupTestData.ts                                        ✅
    └── transactionHelpers.ts                                   ✅
```

---

## Implementation Summary

### Phase 1: Test Framework Enhancement ✅

1. **Contract Deployment** - `contractDeployment.ts`
   - `deployAndCreateFactory()` - Uploads DAR, creates OcpFactory
   - `authorizeIssuerWithFactory()` - Authorizes issuers using factory
   - `findExistingFactory()` - Checks for existing factory contracts
   - Idempotent - doesn't re-deploy if already present

2. **Enhanced Test Harness** - `integrationTestHarness.ts`
   - Automatic DAML deployment on first test run
   - Factory creation during `beforeAll`
   - Extended context with `systemOperatorParty` and `ocpFactoryContractId`

3. **Updated Setup Functions** - `setupTestData.ts`
   - `setupTestIssuer()` now supports both LocalNet (factory) and devnet/mainnet (SDK)
   - Optional `systemOperatorParty` and `ocpFactoryContractId` params
   - Backwards compatible with existing tests

4. **Transaction Helpers** - `transactionHelpers.ts`
   - `extractContractIdOrThrow()` - Type-safe contract ID extraction
   - `extractContractIdByTemplatePattern()` - Find contracts by template
   - Uses type guards instead of `any` casts

5. **All Core Entity Tests** - 17 OpenCapTable entity tests implemented

### Phase 2: CI Integration ✅

CI integration with cn-quickstart implemented in `.github/workflows/test-ocp-quickstart.yml`:

- Runs on every push and daily schedule
- Automatically starts cn-quickstart with shared-secret auth
- Deploys DAML contracts and runs integration tests

### Out of Scope

Full payment/stream/report tests require Canton Network infrastructure (Amulet, wallet, payment
streams) not available in LocalNet. These are tracked separately in
[2026.01.08-remaining-integration-tests.md](../../2026/01/ai/2026.01.08-remaining-integration-tests.md).

---

## Running Tests

### Prerequisites

1. Start cn-quickstart LocalNet:

```bash
cd libs/cn-quickstart/quickstart
make start
```

2. Wait for LocalNet to be ready:

```bash
npm run wait:localnet
```

### Run Tests

```bash
# Run all integration tests
OCP_TEST_USE_CN_QUICKSTART_DEFAULTS=true npm run test:integration

# Run specific entity tests
OCP_TEST_USE_CN_QUICKSTART_DEFAULTS=true npx jest test/integration/entities/issuer --runInBand

# With debug output
DEBUG=true OCP_TEST_USE_CN_QUICKSTART_DEFAULTS=true npm run test:integration
```

### Environment Variables

| Variable                                   | Description                       |
| ------------------------------------------ | --------------------------------- |
| `OCP_TEST_USE_CN_QUICKSTART_DEFAULTS=true` | Enable LocalNet testing           |
| `OCP_TEST_ISSUER_PARTY`                    | Override issuer party ID          |
| `OCP_TEST_SYSTEM_OPERATOR_PARTY`           | Override system operator party ID |
| `OCP_TEST_DAR_FILE_PATH`                   | Custom DAR file path              |

---

## Validation

Before opening PRs:

```bash
cd ocp-canton-sdk
npm run fix        # ESLint + Prettier
npm run typecheck  # TypeScript type checking (REQUIRED)
npm test           # Unit tests
```

---

## Acceptance Criteria

### ✅ Complete

- [x] Test framework deploys DAML contracts dynamically
- [x] OcpFactory created without placeholders
- [x] All 17 OpenCapTable entity tests use factory context
- [x] Tests run end-to-end against LocalNet
- [x] TypeScript type safety maintained (no `any` types)
- [x] Documentation updated
- [x] Type-safe transaction helpers created
- [x] CI integration with cn-quickstart

### Out of Scope (Tracked Separately)

- Full payment/stream tests require Canton payment infrastructure
- See
  [2026.01.08-remaining-integration-tests.md](../../2026/01/ai/2026.01.08-remaining-integration-tests.md)

---

## Changelog

| Date       | Change                                                 | PRs                                     |
| ---------- | ------------------------------------------------------ | --------------------------------------- |
| 2025-01-02 | Moved from canton to ocp-canton-sdk                    | -                                       |
| 2025-12-30 | Created comprehensive integration tests task           | -                                       |
| 2025-12-30 | Added contract deployment and factory creation         | feature/comprehensive-integration-tests |
| 2025-12-30 | Updated all entity tests to use factory context        | feature/comprehensive-integration-tests |
| 2025-12-30 | Added type-safe transaction helpers, fixed party usage | feature/comprehensive-integration-tests |
| 2026-01-12 | Renamed to standalone task, marked as complete         | -                                       |
