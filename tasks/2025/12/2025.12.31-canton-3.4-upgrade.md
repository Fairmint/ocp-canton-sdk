# Task: Canton 3.4 Upgrade

**Date**: 2025-12-31  
**Status**: Blocked  
**Target Repo**: `ocp-canton-sdk`  
**Parent Task**:
[canton/tasks/2025/12/2025.12.31-canton-3.4-upgrade.md](https://github.com/Fairmint/canton/blob/main/tasks/2025/12/2025.12.31-canton-3.4-upgrade.md)

## Goal

Update the OCP Canton SDK to be compatible with Canton 3.4 by upgrading dependencies and making any
necessary code changes.

---

## Prerequisites

This task is **blocked** until the following upstream packages are updated for Canton 3.4:

| Package                                    | Current | Required | Status  | Repo                          |
| ------------------------------------------ | ------- | -------- | ------- | ----------------------------- |
| `@fairmint/canton-node-sdk`                | 0.0.148 | TBD      | Pending | `canton-node-sdk`             |
| `@fairmint/open-captable-protocol-daml-js` | 0.2.68  | TBD      | Pending | `open-captable-protocol-daml` |

**Dependency order:**

1. `canton-node-sdk` must update first (low-level Canton client)
2. `open-captable-protocol-daml-js` updates next (depends on canton-node-sdk)
3. This SDK (`ocp-canton-sdk`) updates last

---

## Background

Canton 3.4 brings changes to the DAML/Canton infrastructure. This SDK depends on:

| Package                                    | Current | Target  | Impact                                          |
| ------------------------------------------ | ------- | ------- | ----------------------------------------------- |
| `@fairmint/canton-node-sdk`                | 0.0.148 | TBD     | **Pre-req** - Must update first                 |
| `@fairmint/open-captable-protocol-daml-js` | 0.2.68  | 0.2.86+ | **Pre-req** - Must update after canton-node-sdk |
| `@daml/ledger`                             | 2.10.3  | 2.10.3  | **No change** - Already at latest stable        |
| `@daml/types`                              | 3.4.10  | 3.4.10  | **No change** - Already at latest stable        |

### Research: @daml packages

**Findings (2026-01-12):**

- `@daml/ledger`: Latest stable version is **2.10.3** (we already have this)
- `@daml/types`: Latest stable version is **3.4.10** (we already have this)
- Snapshot versions exist (up to 3.5.x) but are not recommended for production
- **Conclusion**: No @daml package updates needed for Canton 3.4

### Research: LocalNet (cn-quickstart)

**Findings (2026-01-12):**

- ✅ **cn-quickstart supports Canton 3.4** - Confirmed via Digital Asset documentation
- Documentation available at: https://docs.digitalasset.com/build/3.4/quickstart/
- cn-quickstart is configured as a git submodule at `libs/cn-quickstart`
- **Conclusion**: LocalNet is available for testing once prerequisites are met

---

## Scope

### In Scope

1. **Dependency Updates**
   - [ ] Upgrade `@fairmint/canton-node-sdk` when Canton 3.4 version is released
   - [ ] Upgrade `@fairmint/open-captable-protocol-daml-js` when Canton 3.4 version is released
   - [x] ~~Update `@daml/ledger` and `@daml/types`~~ — Not needed (already at latest stable)

2. **Code Changes**
   - [ ] Update any type imports that changed in new DAML bindings
   - [ ] Fix any breaking API changes in canton-node-sdk
   - [ ] Update type conversions if DAML schema changed
   - [ ] Fix any deprecated API usage

3. **Testing**
   - [ ] Verify all unit tests pass
   - [ ] Verify all integration tests pass against Canton 3.4 LocalNet
   - [ ] Test type checking passes (`npm run typecheck`)

### Out of Scope

- New feature development
- DAML contract changes (handled in separate repos)
- Performance optimization

---

## Implementation Plan

### Phase 1: Wait for Prerequisites

Monitor upstream package releases:

- [ ] `@fairmint/canton-node-sdk` released with Canton 3.4 support
- [ ] `@fairmint/open-captable-protocol-daml-js` released with Canton 3.4 support

### Phase 2: Dependency Upgrades

```bash
# Update Fairmint packages to Canton 3.4 versions
npm install --save-exact @fairmint/canton-node-sdk@<canton-3.4-version>
npm install --save-exact @fairmint/open-captable-protocol-daml-js@<canton-3.4-version>
```

### Phase 3: Code Updates

1. Run type check to identify breaking changes:

   ```bash
   npm run typecheck
   ```

2. Fix any type errors:
   - Updated template IDs
   - Changed field names
   - New required fields
   - Removed fields

3. Review and update type conversions in:
   - `src/utils/typeConversions.ts`
   - `src/types/native.ts`

### Phase 4: Verification

```bash
# Full validation
npm run fix
npm run typecheck
npm test
npm run test:integration
```

---

## Success Criteria

- [ ] All dependencies updated to Canton 3.4 compatible versions
- [ ] `npm run typecheck` passes with no errors
- [ ] `npm run lint` passes with no warnings
- [ ] `npm test` (unit tests) pass
- [ ] `npm run test:integration` pass against Canton 3.4 LocalNet
- [ ] No regressions in SDK functionality

---

## Dependencies

| Dependency                                             | Status       | Notes                            |
| ------------------------------------------------------ | ------------ | -------------------------------- |
| `@fairmint/canton-node-sdk` Canton 3.4 release         | ⏳ Pending   | Must release first               |
| `@fairmint/open-captable-protocol-daml-js` 3.4 release | ⏳ Pending   | Depends on canton-node-sdk       |
| Canton 3.4 LocalNet (cn-quickstart)                    | ✅ Available | Confirmed via Digital Asset docs |

---

## Notes

- Pinned dependencies: Always use exact versions without `^` or `~`
- Run `npm run fix` before committing to ensure code style compliance
- Test against LocalNet before marking complete

---

## Changelog

| Date       | Change                                                            | PRs |
| ---------- | ----------------------------------------------------------------- | --- |
| 2026-01-12 | Added research findings, prerequisites, updated status to Blocked | —   |
| 2025-12-31 | Task created for ocp-canton-sdk                                   | —   |

---

_Last updated: 2026-01-12_
