# Task: Canton 3.4 Upgrade

**Date**: 2025-12-31  
**Status**: Complete  
**Target Repo**: `ocp-canton-sdk`  
**Parent Task**:
[canton/tasks/2025/12/2025.12.31-canton-3.4-upgrade.md](https://github.com/Fairmint/canton/blob/main/tasks/2025/12/2025.12.31-canton-3.4-upgrade.md)

## Goal

Update the OCP Canton SDK to be compatible with Canton 3.4 by upgrading dependencies and making any
necessary code changes.

---

## Prerequisites

All prerequisites have been met:

| Package                                    | Previous | Current | Status     | Repo                          |
| ------------------------------------------ | -------- | ------- | ---------- | ----------------------------- |
| `@fairmint/canton-node-sdk`                | 0.0.148  | 0.0.157 | ✅ Updated | `canton-node-sdk`             |
| `@fairmint/open-captable-protocol-daml-js` | 0.2.68   | 0.2.106 | ✅ Updated | `open-captable-protocol-daml` |

**Dependency order:**

1. ✅ `canton-node-sdk` updated first (low-level Canton client)
2. ✅ `open-captable-protocol-daml-js` updated next (depends on canton-node-sdk)
3. ✅ This SDK (`ocp-canton-sdk`) updated last

---

## Background

Canton 3.4 brings changes to the DAML/Canton infrastructure. This SDK depends on:

| Package                                    | Previous | Current | Status                                   |
| ------------------------------------------ | -------- | ------- | ---------------------------------------- |
| `@fairmint/canton-node-sdk`                | 0.0.148  | 0.0.157 | ✅ Updated for Canton 3.4                |
| `@fairmint/open-captable-protocol-daml-js` | 0.2.68   | 0.2.106 | ✅ Updated for Canton 3.4                |
| `@daml/ledger`                             | 2.10.3   | 2.10.3  | **No change** - Already at latest stable |
| `@daml/types`                              | 3.4.10   | 3.4.10  | **No change** - Already at latest stable |

### Research: @daml packages

**Findings (2026-01-12):**

- `@daml/ledger`: Latest stable version is **2.10.3** (we already have this)
- `@daml/types`: Latest stable version is **3.4.10** (we already have this)
- Snapshot versions exist (up to 3.5.x) but are not recommended for production
- **Conclusion**: No @daml package updates needed for Canton 3.4

### Research: LocalNet (cn-quickstart)

**Findings (2026-01-12):**

- ✅ **cn-quickstart supports Canton 3.4** - Confirmed via Digital Asset documentation
- Documentation available at: https://docs.digitalasset.com/build/3.4/quickstart/
- cn-quickstart is configured as a git submodule at `libs/cn-quickstart`
- **Conclusion**: LocalNet is available for testing once prerequisites are met

---

## Scope

### In Scope

1. **Dependency Updates**
   - [x] Upgrade `@fairmint/canton-node-sdk` to 0.0.157
   - [x] Upgrade `@fairmint/open-captable-protocol-daml-js` to 0.2.106
   - [x] ~~Update `@daml/ledger` and `@daml/types`~~ — Not needed (already at latest stable)

2. **Code Changes**
   - [x] Update any type imports that changed in new DAML bindings — No breaking changes
   - [x] Fix any breaking API changes in canton-node-sdk — No breaking changes
   - [x] Update type conversions if DAML schema changed — No schema changes
   - [x] Fix any deprecated API usage — None found

3. **Testing**
   - [x] Verify all unit tests pass (91 tests passing)
   - [x] Verify all integration tests pass against Canton 3.4 LocalNet (via CI)
   - [x] Test type checking passes (`npm run typecheck`)

### Out of Scope

- New feature development
- DAML contract changes (handled in separate repos)
- Performance optimization

---

## Implementation Plan

### Phase 1: Wait for Prerequisites ✅

Upstream package releases:

- [x] `@fairmint/canton-node-sdk` released with Canton 3.4 support (0.0.157)
- [x] `@fairmint/open-captable-protocol-daml-js` released with Canton 3.4 support (0.2.106)

### Phase 2: Dependency Upgrades ✅

Dependencies upgraded via PR #142:

```bash
# Updated Fairmint packages to Canton 3.4 versions
npm install --save-exact @fairmint/canton-node-sdk@0.0.157
npm install --save-exact @fairmint/open-captable-protocol-daml-js@0.2.106
```

### Phase 3: Code Updates ✅

No breaking changes found. The upgrade was seamless:

1. Type check passed with no errors
2. No type errors to fix:
   - Template IDs unchanged
   - Field names unchanged
   - No new required fields
   - No removed fields
3. No changes needed to type conversions

### Phase 4: Verification ✅

All validation checks passed:

```bash
npm run typecheck  # ✅ Pass
npm run lint       # ✅ Pass (0 warnings)
npm test           # ✅ Pass (91 tests)
npm run test:integration  # ✅ Pass (verified in CI)
```

---

## Success Criteria

- [x] All dependencies updated to Canton 3.4 compatible versions
- [x] `npm run typecheck` passes with no errors
- [x] `npm run lint` passes with no warnings
- [x] `npm test` (unit tests) pass — 91 tests passing
- [x] `npm run test:integration` pass against Canton 3.4 LocalNet — verified in CI
- [x] No regressions in SDK functionality

---

## Dependencies

| Dependency                                             | Status       | Notes                            |
| ------------------------------------------------------ | ------------ | -------------------------------- |
| `@fairmint/canton-node-sdk` Canton 3.4 release         | ✅ Complete  | Updated to 0.0.157               |
| `@fairmint/open-captable-protocol-daml-js` 3.4 release | ✅ Complete  | Updated to 0.2.106               |
| Canton 3.4 LocalNet (cn-quickstart)                    | ✅ Available | Confirmed via Digital Asset docs |

---

## Notes

- Pinned dependencies: Always use exact versions without `^` or `~`
- Run `npm run fix` before committing to ensure code style compliance
- Test against LocalNet before marking complete

---

## Changelog

| Date       | Change                                                            | PRs |
| ---------- | ----------------------------------------------------------------- | --- |
| 2026-01-16 | Task completed - all dependencies updated, tests passing          | —   |
| 2026-01-12 | Added research findings, prerequisites, updated status to Blocked | —   |
| 2025-12-31 | Task created for ocp-canton-sdk                                   | —   |

---

_Last updated: 2026-01-16_
