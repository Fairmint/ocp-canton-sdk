name: Test OCP CN-Quickstart Integration

on:
  push:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  test-ocp-quickstart:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Initialize Submodules
        run: |
          git submodule update --init --depth 1 libs/Open-Cap-Format-OCF
          git submodule update --init --depth 1 libs/splice
          git submodule update --init --recursive libs/cn-quickstart

      - name: Install dependencies
        run: npm install

      - name: Build package
        run: npm run build

      - name: Setup CN-Quickstart (shared-secret)
        run: |
          cd libs/cn-quickstart/quickstart
          # Setup with shared-secret mode
          # The setup wizard asks:
          #   1. "Enable Observability? (Y/n):" - answer Y (default)
          #   2. "Enable OAUTH2? (Y/n):" - answer n for shared-secret mode
          #   3. "Specify a party hint..." - accept default (empty)
          printf "Y\nn\n\n" | make setup || true

      - name: Install Daml SDK
        run: |
          cd libs/cn-quickstart/quickstart
          make install-daml-sdk

      - name: Add Daml CLI to PATH
        run: echo "$HOME/.daml/bin" >> $GITHUB_PATH

      - name: Start CN-Quickstart
        run: |
          cd libs/cn-quickstart/quickstart
          make start

      - name: Wait for Services
        run: |
          echo "Waiting for services to be healthy..."
          for i in {1..40}; do
            SPLICE_HEALTHY=$(docker ps --filter "name=^splice$" --format "{{.Status}}" | grep -c "healthy" || true)
            ONBOARDING_HEALTHY=$(docker ps --filter "name=splice-onboarding" --format "{{.Status}}" | grep -c "healthy" || true)

            if [ "$SPLICE_HEALTHY" -gt 0 ] && [ "$ONBOARDING_HEALTHY" -gt 0 ]; then
              echo "âœ“ Core services are healthy"
              docker ps --format "table {{.Names}}\t{{.Status}}" | head -10
              break
            fi
            echo "Waiting for services... ($i/40)"
            sleep 15
          done

          echo "Waiting for Ledger JSON API..."
          OCP_TEST_AUTH_MODE=shared-secret node_modules/.bin/ts-node scripts/quickstart/waitForReady.ts

      # Note: Contract deployment is handled automatically by the integration test harness.
      # It discovers DAR files from @fairmint/open-captable-protocol-daml-js npm package.

      - name: Run integration smoke tests
        env:
          OCP_TEST_AUTH_MODE: 'shared-secret'
        run: npm run test:integration:ci

      - name: Show Logs on Failure
        if: failure()
        run: |
          echo "==================== Docker Containers ===================="
          docker ps -a || true

          echo "==================== Docker Compose Logs ===================="
          if [ -d "libs/cn-quickstart/quickstart" ]; then
            cd libs/cn-quickstart/quickstart
            docker compose logs --tail=200 || true
          fi

          echo "==================== Canton Logs ===================="
          if [ -f libs/cn-quickstart/quickstart/logs/canton.log ]; then
            tail -200 libs/cn-quickstart/quickstart/logs/canton.log
          fi
